%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt, openany,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage[english]{babel}



\usepackage{times}
\expandafter\ifx\csname T@LGR\endcsname\relax
\else
% LGR was declared as font encoding
  \substitutefont{LGR}{\rmdefault}{cmr}
  \substitutefont{LGR}{\sfdefault}{cmss}
  \substitutefont{LGR}{\ttdefault}{cmtt}
\fi
\expandafter\ifx\csname T@X2\endcsname\relax
  \expandafter\ifx\csname T@T2A\endcsname\relax
  \else
  % T2A was declared as font encoding
    \substitutefont{T2A}{\rmdefault}{cmr}
    \substitutefont{T2A}{\sfdefault}{cmss}
    \substitutefont{T2A}{\ttdefault}{cmtt}
  \fi
\else
% X2 was declared as font encoding
  \substitutefont{X2}{\rmdefault}{cmr}
  \substitutefont{X2}{\sfdefault}{cmss}
  \substitutefont{X2}{\ttdefault}{cmtt}
\fi


\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}



% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}


\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}


% The pdf output has too large picture compared to the html output.
% The next statement reduces the figure size
\pdfpxdimen=0.75\sphinxpxdimen

% Format of chapter fonts
\makeatletter
\ChNameVar{\raggedleft\sf\bfseries\Large} % sets the style for name
\ChNumVar{\raggedleft\sf\bfseries\Large} % sets the style for name
\ChTitleVar{\raggedleft\sf\bfseries\Large} % sets the style for name
\makeatother


\usepackage[scaled]{helvet}
\usepackage[helvet]{sfmath}

%% Fontsizes according to guideline from Andreas Eckmanns, Aug. 2018
\usepackage{sectsty}
\chapterfont{\fontsize{24}{26}\selectfont}
\sectionfont{\fontsize{14}{16}\selectfont}
\subsectionfont{\fontsize{12}{14}\selectfont}

%\usepackage[T1]{fontenc}
%%\titleformat*{\chapter}{\fontencoding{OT1}\fontfamily{cmr}\fontseries{m}%
%%  \fontshape{n}\fontsize{24pt}{24}\selectfont}
%%\titleformat*{\section}{\fontencoding{OT1}\fontfamily{cmr}\fontseries{m}%
%%  \fontshape{n}\fontsize{6pt}{6}\selectfont}
%%\titleformat*{\subsection}{\fontencoding{OT1}\fontfamily{cmr}\fontseries{m}%
%%  \fontshape{n}\fontsize{12pt}{12}\selectfont}
%%\titleformat*{\subsubsection}{\fontencoding{OT1}\fontfamily{cmr}\fontseries{m}%
%%  \fontshape{n}\fontsize{11pt}{11}\selectfont}
\titleformat*{\paragraph}
  {\rmfamily\slshape}
  {}{}{}
  \titlespacing{\paragraph}
  {0pc}{1.5ex minus .1 ex}{0pc}

\renewcommand\familydefault{\sfdefault}
\renewcommand{\baselinestretch}{1.1}


\usepackage{xcolor}
\definecolor{OldLace}{rgb}{0.99, 0.96, 0.9}
\definecolor{light-gray}{gray}{0.95}
\sphinxsetup{%
  verbatimwithframe=false,
  VerbatimColor={named}{light-gray},
%  TitleColor={named}{DarkGoldenrod},
%  hintBorderColor={named}{LightCoral},
  attentionborder=3pt,
%  attentionBorderColor={named}{Crimson},
%  attentionBgColor={named}{FloralWhite},
  noteborder=2pt,
  noteBorderColor={named}{light-gray},
  cautionborder=3pt,
%  cautionBorderColor={named}{Cyan},
%  cautionBgColor={named}{LightCyan}
}


\usepackage{sectsty}
\definecolor{lbl}{RGB}{2, 46, 77}
\chapterfont{\color{lbl}}  % sets colour of chapters
\sectionfont{\color{lbl}}  % sets colour of sections
\subsectionfont{\color{lbl}}  % sets colour of sections


% Reduce the list spacing
\usepackage{enumitem}
\setlist{nosep} % or \setlist{noitemsep} to leave space around whole list

% This allows adding :cite: in the label of figures.
% It is a work-around for https://github.com/mcmtroffaes/sphinxcontrib-bibtex/issues/92
\usepackage{etoolbox}
\AtBeginEnvironment{figure}{\renewcommand{\phantomsection}{}}



\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}


\setcounter{secnumdepth}{3}
\usepackage{amssymb,amsmath}

% Figure and table caption in italic fonts
\makeatletter
\renewcommand{\fnum@figure}[1]{\small \textit{\figurename~\thefigure}: \it }
\renewcommand{\fnum@table}[1]{\small \textit{\tablename~\thetable}: \it }
\makeatother

% The next two lines patch the References title
\usepackage{etoolbox}
\patchcmd{\thebibliography}{\chapter*}{\phantom}{}{}

\definecolor{TitleColor}{rgb}{0 ,0 ,0} % black rathern than blue titles

\renewcommand{\Re}{{\mathbb R}}
\newcommand{\Na}{{\mathbb N}}
\newcommand{\Z}{{\mathbb Z}}

\usepackage{listings}
% see: http://mirror.aarnet.edu.au/pub/CTAN/macros/latex/contrib/listings/listings-1.3.pdf
\lstset{%
  basicstyle=\small, % print whole listing small
  keywordstyle=\color{red},
  identifierstyle=, % nothing happens
  commentstyle=\color{blue}, % white comments
  stringstyle=\color{OliveGreen}\it, % typewriter type for strings
  showstringspaces=false,
  numbers=left,
  numberstyle=\tiny,
  numbersep=5pt} % no special string space

\lstset{
    frame=single,
    breaklines=true,
    postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{red}\hookrightarrow\space}}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstdefinelanguage{Modelica}{%
  morekeywords={Thermal,HeatTransfer,Interfaces, flow, %
    SI,Temperature,HeatFlowRate,HeatPort},
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]",
  emph={equation, partial, connector, model, public, end, %
    extends, parameter}, emphstyle=\color{blue},
}

\usepackage[margin=0.75in, includehead, includefoot, centering]{geometry}

% Replace the threeparttable as it causes the caption to
% be no wider than the table, which looks quite bad.
% Also, center the caption and table.
%\renewenvironment{threeparttable}{ \begin{table}\centering }{ \end{table} }
% Increase distance of caption
\belowcaptionskip=5pt


\pagestyle{normal}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[RE]{\leftmark}
\fancyhead[LO]{\rightmark}
\fancypagestyle{plain}{%
   \fancyhead{} % get rid of headers
   \fancyhead[R]{\leftmark}
   \fancyfoot[R]{\thepage}
   \fancyfoot[L]{}
   \renewcommand{\headrulewidth}{0.5pt} % and the line
}

%%\rfoot[LE,RO]{\thepage}
%%\renewcommand{\headrulewidth}{0.4pt}
%%\renewcommand{\footrulewidth}{0.4pt}

\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}

\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}

%\hypersetup{hidelinks = true} % Makefile enables this for the 2 page printout

% Set format of table of content. Otherwise, the titles stick to the page numbers in some cases
\usepackage[tocgraduated]{tocstyle}
\usetocstyle{nopagecolumn}
\usepackage{pdfpages}

\usepackage{tikz}
\usepackage{graphicx}
\usetikzlibrary{calc}
\usepackage{textcomp}


\title{Linkage Software Requirements Specification}
\date{Nov 02, 2020}
\release{}
\author{V1.1 - Release for External Review}
\newcommand{\sphinxlogo}{\sphinxincludegraphics{lbl-icon.png}\par}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}




\pagestyle{plain}


\chapter{Preamble and Conventions}
\label{\detokenize{preamble:preamble-and-conventions}}\label{\detokenize{preamble::doc}}
This documentation specifies the requirements for Linkage software: \sphinxstyleemphasis{a graphical user interface for editing Modelica models of HVAC and control systems}.
\begin{itemize}
\item {} 
Everything that relates to the software functionalities and the data formats to be consumed and returned must be considered as minimum requirements and implemented in the final deliverables.

\item {} 
However, the specification also provides some implementation strategies when it comes to devising the “assisted modeling” mode, enabling to build complex thermo\sphinxhyphen{}fluid models and control sequences based on a simple HTML input form. Here the proposed design should only be considered as a possible path. Alternative approaches are welcome but they must at least provide the same level of functionalities as the proposed approach and meet the minimum requirements that are expressed.

\end{itemize}

\begin{sphinxadmonition}{warning}{Warning:}
To clearly distinguish what constitutes requirements from what constitutes a design proposition open to some alternative approaches, we will use this warning format throughout the specification.

Furthermore we use the following \sphinxstylestrong{convention}.
\begin{itemize}
\item {} 
The words \sphinxstyleemphasis{must, must not, required, shall, shall not, should, should not, recommended, may, optional} in this document must be interpreted as described in \sphinxhref{https://tools.ietf.org/html/rfc2119}{RFC2119}.

\end{itemize}
\end{sphinxadmonition}


\chapter{Overview}
\label{\detokenize{overview:overview}}\label{\detokenize{overview::doc}}
The software to develop is a graphical user interface for editing Modelica models of HVAC and control systems. It relies on two main components.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
A graphical user interface for editing Modelica classes in a diagrammatic form, see \hyperref[\detokenize{requirements:sec-functionalities}]{Section \ref{\detokenize{requirements:sec-functionalities}}} and \hyperref[\detokenize{requirements:sec-modelica-gui}]{Section \ref{\detokenize{requirements:sec-modelica-gui}}}.

\item {} 
A configuration widget supporting assisted modeling based on a simple HTML input form, see \hyperref[\detokenize{requirements:sec-configuration-widget}]{Section \ref{\detokenize{requirements:sec-configuration-widget}}}. This widget is mostly needed for integrating advanced control sequences that can have dozens of I/O variables. The intent is to reduce the complexity to the mere definition of the system layout and the selection of standard control sequences already transcribed in Modelica.

\end{enumerate}

We plan a phased development where
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
the configuration widget will be first implemented as part of Phase 1 and integrated into an existing graphical editor for Modelica,

\item {} 
the full\sphinxhyphen{}featured editor will be developed in a future phase, providing diagrammatic editing capabilities and integrating the configuration widget natively.

\end{enumerate}

\begin{sphinxadmonition}{note}{Revision Note (11/2020)}

The current version of the specification is limited to Phase 1. Each part related to the full\sphinxhyphen{}featured editor is provided for informative purposes only.
\end{sphinxadmonition}



\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{overview_1}.pdf}
\end{figure}

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{overview_2}.pdf}
\end{figure}

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{overview_3}.pdf}
\end{figure}


\chapter{Requirements}
\label{\detokenize{requirements:requirements}}\label{\detokenize{requirements:sec-requirements}}\label{\detokenize{requirements::doc}}
\begin{sphinxadmonition}{note}{Note:}
Most of the concepts used to develop that specification are defined in the Modelica Language Specification \sphinxcite{bibliography:modelica2017}.
\end{sphinxadmonition}


\section{General Description}
\label{\detokenize{requirements:general-description}}\label{\detokenize{requirements:sec-general-description}}

\subsection{Main Requirements}
\label{\detokenize{requirements:main-requirements}}
The following requirements apply to both the configuration widget (Phase 1 of the development) and the diagram editor (future phase of the development).
\begin{itemize}
\item {} 
The software must rely on client side JS code with minimal dependencies and must be built down to a single page HTML document (SPA).

\item {} 
A widget structure is required that allows seamless embedding into:
\begin{itemize}
\item {} 
a desktop app \textendash{} with standard access to the local file system,

\item {} 
a standalone web app \textendash{} with access to the local file system limited to Download \& Upload functions of the web browser (potentially with an additional sandbox file system to secure backup in case the app enters an unknown state),

\item {} 
any third\sphinxhyphen{}party application with the suitable framework to serve a single page HTML document executing JS code \textendash{} with access to the local file system through the API of the third\sphinxhyphen{}party application:

\begin{sphinxadmonition}{note}{Revision Note (10/2020)}

This section is modified to require “proof of concept” for third party integration through a demonstration and not through a completed integration.
\end{sphinxadmonition}
\begin{itemize}
\item {} 
For the first development phase pertaining to the configuration widget, the third\sphinxhyphen{}party application for the widget integration is an existing graphical editor for Modelica.
To demonstrate the feasibility of this integration, a proof of concept shall be developed, together with the documentation describing how this workflow can be accomplished.
This will include the creation of a prototype where the host application may be an actual Modelica editor or a rudimentary emulator of such.

\item {} 
For the second development phase, the primary integration target is \sphinxhref{https://www.openstudio.net}{OpenStudio®} (OS) while the widget to be integrated is now the full\sphinxhyphen{}featured editor (including the configuration widget).
An example of a JS application embedded in OS is \sphinxhref{https://nrel.github.io/OpenStudio-user-documentation/reference/geometry\_editor}{FloorspaceJS}. The standalone SPA lives here: \sphinxurl{https://nrel.github.io/floorspace.js}. FloorspaceJS may be considered as a reference for the development.

\end{itemize}

\end{itemize}

\item {} 
The diagram editor must consume and return Modelica classes formatted into JSON. LBL has developed a \sphinxhref{https://lbl-srg.github.io/modelica-json/}{Modelica to JSON translator} that should be used for these formatting tasks.

\item {} 
A specific data model must be devised for the configuration widget. The recommended format is JSON but alternative formats may be proposed. A minimum requirement is the ability to validate the configuration data against a well documented schema that LBL can maintain. The configuration widget must return Modelica classes formatted into JSON, see previous item.

\end{itemize}

\begin{sphinxadmonition}{note}{Revision Note (10/2020)}

The Python API, if required, will be developed in a subsequent phase.
\end{sphinxadmonition}


\subsection{Software Compatibility}
\label{\detokenize{requirements:software-compatibility}}
The software requirements regarding platform and environment compatibility are presented in \hyperref[\detokenize{requirements:tab-environment}]{Table \ref{\detokenize{requirements:tab-environment}}}.


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Requirements for software compatibility}\label{\detokenize{requirements:id15}}\label{\detokenize{requirements:tab-environment}}
\sphinxaftertopcaption
\begin{tabulary}{\linewidth}[t]{|T|T|}
\hline
\sphinxstyletheadfamily 
Feature
&\sphinxstyletheadfamily 
Support
\\
\hline
Platform (minimum version)
&
Windows (10), Linux Ubuntu (18.04), OS X (10.10)
\\
\hline
Mobile device
&
The software may support iOS and Android
integration though this is not an absolute
requirement.
\\
\hline
Web browser
&
Chrome, Firefox, Safari
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}


\subsection{UI Visual Structure}
\label{\detokenize{requirements:ui-visual-structure}}
\begin{sphinxadmonition}{note}{Revision Note (11/2020)}

Only the requirements pertaining to the configuration widget are retained.
\end{sphinxadmonition}

A responsive design is required.

For the record, a mockup of the UI for the full featured editor is presented \hyperref[\detokenize{requirements:screen-mockup}]{Fig.\@ \ref{\detokenize{requirements:screen-mockup}}}.
For Phase 1, only the graphical features pertaining to the configuration widget in the right panel should be considered.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{screen_mockup}.pdf}
\caption{UI Visual Structure}\label{\detokenize{requirements:screen-mockup}}\end{figure}


\section{Detailed Functionalities}
\label{\detokenize{requirements:detailed-functionalities}}\label{\detokenize{requirements:sec-functionalities}}
\hyperref[\detokenize{requirements:tab-gui-func}]{Table \ref{\detokenize{requirements:tab-gui-func}}} provides a list of the functionalities that the software must support. Phase 1 refers to the configuration widget, future work refers to the full\sphinxhyphen{}featured editor.

\begin{sphinxadmonition}{note}{Revision Note}
\begin{itemize}
\item {} 
\sphinxstylestrong{(10/2020)} The features “Copy/Paste Objects” and “Undo/Redo” are optional and not required for Phase 1.

\item {} 
\sphinxstylestrong{(11/2020)} \hyperref[\detokenize{requirements:tab-gui-func}]{Table \ref{\detokenize{requirements:tab-gui-func}}} is edited to focus on requirements pertaining to Phase 1.

\end{itemize}
\end{sphinxadmonition}


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Functionalities of the software \textendash{} R: required, P: required partially, O: optional, N: not required}\label{\detokenize{requirements:id16}}\label{\detokenize{requirements:tab-gui-func}}
\sphinxaftertopcaption
\begin{tabular}[t]{|\X{30}{100}|\X{10}{100}|\X{10}{100}|\X{50}{100}|}
\hline
\sphinxstyletheadfamily 
Feature
&\sphinxstyletheadfamily 
Phase 1
&\sphinxstyletheadfamily 
Future
&\sphinxstyletheadfamily 
Comment
\\
\hline
\sphinxstylestrong{Main functionalities}
&&&
(as per \hyperref[\detokenize{requirements:sec-general-description}]{Section \ref{\detokenize{requirements:sec-general-description}}})
\\
\hline
Diagram editor for Modelica classes
&
N
&
R
&
In the first phase, the configuration widget must be integrated into an existing diagram editor for Modelica. Such an editor must be developed in the second phase.
\\
\hline
Configuration widget
&
R
&
R
&\\
\hline
Documentation export
&
R
&
R
&
See \hyperref[\detokenize{requirements:sec-documentation-export}]{Section \ref{\detokenize{requirements:sec-documentation-export}}}.
\\
\hline
\sphinxstylestrong{I/O}
&&&\\
\hline
Export documentation
&
R
&
R
&
Control points, sequence of operation description (based on CDL to Word translator developed by LBL), and equipment schematics see \hyperref[\detokenize{requirements:sec-documentation-export}]{Section \ref{\detokenize{requirements:sec-documentation-export}}}
\\
\hline
\sphinxstylestrong{Modelica features}
&&&\\
\hline
Automatic medium propagation between connected components
&
R
&
O
&
Only the configuration widget integrates this feature as a minimum requirement.

When generating \sphinxcode{\sphinxupquote{connect}} equations manually within the diagram editor, a similar approach as the \sphinxstyleemphasis{fluid path} used by the configuration widget may be developed, see components with four ports and two media.
\\
\hline
Modelica code editor
&
N
&
R
&
Raw text editor with linter and Modelica specification checking upon save

Note that this functionality requires translation and reverse translation of JSON to Modelica (those translators are developed by LBL).
\\
\hline
Library version management
&
R
&
R
&
If a loaded class contains the Modelica annotation \sphinxcode{\sphinxupquote{uses}} (e.g., \sphinxcode{\sphinxupquote{uses(Buildings(version="6.0.0")}}) the software checks the version number of the stored library, prompts the user for update if the version number does not match, executes the conversion script per user request.
\\
\hline
Path discovery
&
R
&
R
&
A routine to reconstruct the path or URL of a referenced resource within the loaded Modelica libraries is required. Typically a resource can be referenced with the following syntax \sphinxcode{\sphinxupquote{modelica://Buildings.Air.Systems.SingleZone.VAV}}.
\\
\hline
\sphinxstylestrong{Object manipulation}
&&&\\
\hline
Avoiding duplicate names
&
R
&
R
&
When instantiating a component or assigning a name through the configuration widget, if the default name is already used in the class the software automatically appends the name with the lowest integer value that would ensure uniqueness.

When copying and pasting a set of objects connected together, the set of connect equations is updated to ensure  consistency with the appended object names.
\\
\hline
\sphinxstylestrong{Graphical features}
&&&
A user experience similar to modern web apps is expected e.g. \sphinxhref{https://tranedesignassist.com/}{tranedesignassist.com}.
\\
\hline
Copy/Paste objects
&
O
&
R
&
Copying and pasting a set of objects connected together copies the objects declarations and the corresponding connect  equations.
\\
\hline
Pan and zoom on mouse actions
&
N
&
R
&\\
\hline
Undo/Redo
&
O
&
R
&
Available through buttons and standard keyboard shortcuts
\\
\hline
Hover information
&
R
&
R
&
Class path when hovering an object in the diagram view and tooltip help for each GUI element
\\
\hline
\sphinxstylestrong{Miscellaneous}
&&&\\
\hline
Internationalization
&
R
&
R
&
The software will be delivered in US English only, but it must be architectured to allow seamless integration of additional languages in the future.

The choice between I\sphinxhyphen{}P and SI units must be possible. The mechanism supporting different units will be specified by LBL in a later version of this document.
\\
\hline
User documentation
&
R
&
R
&
User manual of the GUI and the corresponding API

Both an HTML version and a PDF version are required (may rely on Sphinx).
\\
\hline
Developer documentation
&
R
&
R
&
All classes, methods, free functions, and schemas must be documented with an exhaustive description of the functionalities, parameters, return values, etc.

UML diagrams should also be provided.

At least an HTML version is required, PDF version is optional (may rely on Sphinx or VuePress).
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}


\section{Requirements Related to the Modelica Language}
\label{\detokenize{requirements:requirements-related-to-the-modelica-language}}\label{\detokenize{requirements:sec-modelica-gui}}
\begin{sphinxadmonition}{note}{Revision Note (11/2020)}

This paragraph replaces the paragraph “Modelica Graphical User Interface” and only retains the requirements pertaining to the configuration widget.
\end{sphinxadmonition}


\subsection{Language Specification}
\label{\detokenize{requirements:language-specification}}
The software must comply with the Modelica language specification \sphinxcite{bibliography:modelica2017} for every aspect relating to (the chapter numbers refer to \sphinxcite{bibliography:modelica2017}):
\begin{itemize}
\item {} 
validating the syntax of the user inputs: see \sphinxstyleemphasis{Chapter 2 Lexical Structure} and \sphinxstyleemphasis{Chapter 3 Operators and Expressions},

\item {} 
the connection between objects: see \sphinxstyleemphasis{Chapter 9 Connectors and Connections},

\item {} 
the structure of packages: see \sphinxstyleemphasis{Chapter 13 Packages},

\item {} 
the annotations: see \sphinxstyleemphasis{Chapter 18 Annotations}.

\end{itemize}


\subsection{JSON Representation}
\label{\detokenize{requirements:json-representation}}
LBL has already developed a \sphinxhref{https://lbl-srg.github.io/modelica-json/}{Modelica to JSON translator}.
This development includes the definition of two JSON schemas:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxhref{https://lbl-srg.github.io/modelica-json/modelica.html}{Schema\sphinxhyphen{}modelica.json} validates the JSON files parsed from Modelica.

\item {} 
\sphinxhref{https://lbl-srg.github.io/modelica-json/CDL.html}{Schema\sphinxhyphen{}CDL.json} validates the JSON files parsed from \sphinxhref{http://obc.lbl.gov/specification/cdl}{CDL} (subset of Modelica language used for control sequence implementation).

\end{enumerate}

Linkage should leverage those developments by consuming and outputting Modelica files formatted into JSON, without having to parse the Modelica syntax.


\section{Configuration Widget}
\label{\detokenize{requirements:configuration-widget}}\label{\detokenize{requirements:sec-configuration-widget}}

\subsection{Functionalities}
\label{\detokenize{requirements:functionalities}}
The configuration widget allows the user to generate a Modelica model of an HVAC system and its controls by filling up a simple input form.
It is mostly needed for integrating advanced control sequences that can have dozens of I/O variables.
The intent is to reduce the complexity to the mere definition of the system layout and the selection of standard control sequences already transcribed in Modelica \sphinxcite{bibliography:obc}.

\begin{sphinxadmonition}{note}{Note:}
\sphinxhref{https://www.ctrlspecbuilder.com/ctrlspecbuilder/home.do;jsessionid=4747144EA3E61E9B82B9E0B463FF2E5F}{CtrlSpecBuilder} is a tool widely used in the HVAC industry for specifying control systems. It may be used as a reference for the development in terms of user experience minimal functionalities. Note that this software does not provide any Modelica modeling functionality.
\end{sphinxadmonition}

There are fundamental requirements regarding the Modelica model generated by the configuration widget:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
It must be “graphically readable” (both within Linkage and within any third\sphinxhyphen{}party Modelica GUI e.g. Dymola): this is a strong constraint regarding the placement of the composing objects and the connections that must be generated automatically.

\item {} 
It must be ready to simulate: no additional modeling work or parameters setting is needed outside the configuration widget.

\item {} 
It must contain all annotations needed to regenerate the HTML input form when loaded, with all entries corresponding to the actual state of the model.
\begin{itemize}
\item {} 
Manual modifications of the Modelica model made by the user are not supported by the configuration widget: an additional annotation should be included in the Modelica file to flag that the model has deviated from the template. In this case the configuration widget is disabled when loading that model.

\end{itemize}

\item {} 
The implementation of control sequences must comply with OpenBuildingControl requirements, see \sphinxstyleemphasis{\S{}7 Control Description Language} and \sphinxstyleemphasis{\S{}8 Code Generation} in \sphinxcite{bibliography:obc}. Especially:
\begin{itemize}
\item {} 
It is required that the CDL part of the model can be programmatically isolated from the rest of the model in order to be translated into vendor\sphinxhyphen{}specific code (by means of a third\sphinxhyphen{}party translator).

\item {} 
The expandable connectors (control bus) are not part of CDL specification. Those are used by the configuration widget to connect
\begin{itemize}
\item {} 
control blocks and equipment models within a composed sub\sphinxhyphen{}system model, e.g., AHU or terminal unit,

\item {} 
different sub\sphinxhyphen{}system models together to compose a whole system model, e.g., VAV system serving different rooms.

\end{itemize}

This is consistent with OpenBuildingControl requirement to provide control sequence specification at the equipment level only (controller programming), not for system level applications (system programming).

\end{itemize}

\end{enumerate}

The input form is provided by the template developer (e.g., LBL) in a data model with a format that is to be further specified in collaboration with the software developer. The minimum requirement is the ability to validate the configuration data against a well documented schema that LBL can maintain.

The data model should typically provide for each entry
\begin{itemize}
\item {} 
the HTML widget and populating data to be used for requesting user input,

\item {} 
the modeling data required to instantiate, position and set the parameters values of the different components,

\item {} 
some tags to be used to automatically generate the connections between the different components connectors.

\end{itemize}

The user interface logic is illustrated in figures \hyperref[\detokenize{requirements:screen-conf-0}]{Fig.\@ \ref{\detokenize{requirements:screen-conf-0}}} and \hyperref[\detokenize{requirements:screen-conf-1}]{Fig.\@ \ref{\detokenize{requirements:screen-conf-1}}}: the comments in those figures are part of the requirements.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{screen_conf_0}.pdf}
\caption{Configuration widget \textendash{} Configuring a new model}\label{\detokenize{requirements:screen-conf-0}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{screen_conf_1}.pdf}
\caption{Configuration widget \textendash{} Configuring an existing model}\label{\detokenize{requirements:screen-conf-1}}\end{figure}

Equipment and controller models are connected together by means of a \sphinxstyleemphasis{control bus}, see \hyperref[\detokenize{requirements:screen-schematics-modelica}]{Fig.\@ \ref{\detokenize{requirements:screen-schematics-modelica}}}. The upper\sphinxhyphen{}level Modelica class including the equipment models and control blocks is the ultimate output of the configuration widget: see \hyperref[\detokenize{requirements:screen-conf-1}]{Fig.\@ \ref{\detokenize{requirements:screen-conf-1}}} where the component named \sphinxcode{\sphinxupquote{AHU\_1\_01\_02}} represents an instance of the upper\sphinxhyphen{}level class \sphinxcode{\sphinxupquote{AHU\_1}} generated by the widget. That component exposes the outside fluid connectors as well as the top level control bus.

The logic for instantiating classes from the library is straightforward. Each field of the form specifies
\begin{itemize}
\item {} 
the reference of the class (library path) to be instantiated depending on the user input,

\item {} 
the position of the component in simplified grid coordinates to be converted in diagram view coordinates.

\end{itemize}

\hyperref[\detokenize{requirements:sec-fluid-connectors}]{Section \ref{\detokenize{requirements:sec-fluid-connectors}}} and \hyperref[\detokenize{requirements:sec-signal-connectors}]{Section \ref{\detokenize{requirements:sec-signal-connectors}}} address how the connections between the connectors of the different components are generated automatically based on this initial model structure.


\subsection{Data Model}
\label{\detokenize{requirements:data-model}}\label{\detokenize{requirements:sec-data-model}}
\begin{sphinxadmonition}{warning}{Warning:}
This paragraph proposes a data model that may be used to support the configuration workflow. This part of the specification is not hard and fast, we are rather trying to illustrate a possible implementation path. Alternative approaches are welcome but they must at least provide the same level of functionalities as the proposed approach and meet the minimum requirements that are expressed.
\end{sphinxadmonition}

The envisioned data structure supporting the configuration process consists in
\begin{itemize}
\item {} 
placement coordinates provided relatively to a simplified grid, see \hyperref[\detokenize{requirements:grid}]{Fig.\@ \ref{\detokenize{requirements:grid}}} \textendash{} those must be mapped to Modelica diagram coordinates by the widget,

\item {} 
an \sphinxcode{\sphinxupquote{equipment}} section referencing the components that must be connected together with fluid connectors, see \hyperref[\detokenize{requirements:sec-fluid-connectors}]{Section \ref{\detokenize{requirements:sec-fluid-connectors}}},

\item {} 
a \sphinxcode{\sphinxupquote{controls}} section referencing the components that must connected together with signal connectors, including schedules, set points, optimal start, etc., see \hyperref[\detokenize{requirements:sec-signal-connectors}]{Section \ref{\detokenize{requirements:sec-signal-connectors}}},

\item {} 
a \sphinxcode{\sphinxupquote{dependencies}} section referencing additional components with the following characteristics:
\begin{itemize}
\item {} 
They typically correspond to sensors and outside fluid connectors.

\item {} 
The model completeness depends on their presence.

\item {} 
The requirements for their presence can be deduced from the equipment and controls options.

\item {} 
They do not need additional fields in the user form of the configuration widget.

\end{itemize}

\end{itemize}


\subsubsection{Format}
\label{\detokenize{requirements:format}}
A robust syntax is a minimum requirement for
\begin{itemize}
\item {} 
auto\sphinxhyphen{}referencing the data structure, for instance \sphinxcode{\sphinxupquote{\#type.value}} refers to the value of the field \sphinxcode{\sphinxupquote{value}} of the object which \sphinxcode{\sphinxupquote{\$id}} is \sphinxcode{\sphinxupquote{type}}, and it must be interpreted by the configuration widget and replaced by the actual value when generating the model,

\item {} 
conditional statements: potentially every field may require a conditional statement \textendash{} either data fields (e.g., the class to be instantiated and its placement) or UI fields (e.g., the condition to enable a widget itself or the different options of a menu widget).

\end{itemize}

Ideally the syntax should also allow iteration \sphinxcode{\sphinxupquote{for}} loops to instantiate a given number (as parameter) of objects with an offset applied to the placement coordinates, for instance a chiller plant with \sphinxcode{\sphinxupquote{n}} chillers. Backup strategy: define a maximum number of instances and enable only the first \sphinxcode{\sphinxupquote{n}} ones based on a condition.

Possible formats:
\begin{itemize}
\item {} 
JSON: recommended format but expensive syntax especially for boolean conditions or auto\sphinxhyphen{}referencing the data structure: is there any standard syntax?

\item {} 
Specific format to be defined in collaboration with the UI developer and depending on the selected UI framework

\end{itemize}


\subsubsection{Parameters Exposed by the Configuration Widget}
\label{\detokenize{requirements:parameters-exposed-by-the-configuration-widget}}
The template developer must have the ability to declare in the template any parameter of the composing components e.g. \sphinxcode{\sphinxupquote{V\_flowSup\_nominal}} and reference them in any declaration e.g. \sphinxcode{\sphinxupquote{Buildings.Fluid.Movers.SpeedControlled\_y(m\_flow\_nominal=(\#air\_supply.medium).rho\_default / 3600 * \#V\_flowSup\_nominal.value)}}. The configuration widget must replace the referenced names by their actual values (literal or numerical). The user will be able to override those values in the parameters panel e.g. if he wants to specify a different nominal air flow rate for the heating or cooling coil. See additional requirements regarding the persistence of those references in \hyperref[\detokenize{requirements:sec-persisting-data}]{Section \ref{\detokenize{requirements:sec-persisting-data}}}.

Some parameters must be integrated in the template (examples below are provided in reference to \sphinxcode{\sphinxupquote{Buildings.Controls.OBC.ASHRAE.G36\_PR1.AHUs.MultiZone.VAV.Controller}})
\begin{itemize}
\item {} 
when they impact the model structure e.g. \sphinxcode{\sphinxupquote{use\_enthalpy}} requires an additional enthalpy sensor: in that case the model declaration must use the \sphinxcode{\sphinxupquote{final}} qualifier to prevent the user from overriding those values in the parameters panel,

\item {} 
when no default value is provided e.g. \sphinxcode{\sphinxupquote{AFlo}} cf. requirement that the model generated by the configuration widget must be ready to simulate.

\end{itemize}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{grid}.png}
\caption{Simplified grid providing placement coordinates for all objects to be instantiated when configuring an AHU model}\label{\detokenize{requirements:grid}}\end{figure}


\subsubsection{Configuration Schema}
\label{\detokenize{requirements:configuration-schema}}
A well documented schema must be developed, to support the development of the configuration files by third parties and the validation of the configuration data input by the user.

In the definitions provided here below
\begin{itemize}
\item {} 
when the type of a field is specified as a string marked with (C), it may correspond to
\begin{itemize}
\item {} 
a conditional statement provided as a string that must be interpreted by the UI engine,

\item {} 
a reference to another field value of type boolean (that may itself correspond to a conditional statement provided as a string).

\end{itemize}

\item {} 
references to other fields of the data structure may be of two kinds:
\begin{itemize}
\item {} 
Linkage references prefixed by \sphinxcode{\sphinxupquote{\#}} which must be interpreted by the configuration widget and replaced by their actual value e.g. \sphinxcode{\sphinxupquote{"declaration": "Modelica.Fluid.Interfaces.FluidPort\_a (redeclare package Medium=\#air\_supply.medium)"}} for the object \sphinxcode{\sphinxupquote{"\$id": "id\_value"}} leads to \sphinxcode{\sphinxupquote{Modelica.Fluid.Interfaces.FluidPort\_a id\_value(redeclare package Medium=Buildings.Media.Air)}} in the generated model.

\item {} 
Modelica references provided as literal variables e.g. \sphinxcode{\sphinxupquote{"declaration": "Buildings.Fluid.Movers.SpeedControlled\_y (m\_flow\_nominal=m\_flowRet\_nominal)"}} for the object if \sphinxcode{\sphinxupquote{"\$id": "id\_value"}} leads to \sphinxcode{\sphinxupquote{Buildings.Fluid.Movers.SpeedControlled\_y id\_value(m\_flow\_nominal=m\_flowRet\_nominal)}} in the generated model.

\end{itemize}

\item {} 
The syntax supporting those features shall be specified in collaboration with the UI developer. The syntax must support e.g. \sphinxcode{\sphinxupquote{(\#air\_supply.medium).rho\_default}} where the first dot is used to access the property \sphinxcode{\sphinxupquote{medium}} of the configuration object with \sphinxcode{\sphinxupquote{\$id == \#air\_supply}} (which must be replaced by its value) while the second dot is used to access Modelica property \sphinxcode{\sphinxupquote{rho\_default}} of the class \sphinxcode{\sphinxupquote{Medium}} (which must be kept literal).

\end{itemize}
\phantomsection\label{\detokenize{requirements:configuration-data}}
\sphinxstylestrong{Definitions}
\begin{quote}

\sphinxcode{\sphinxupquote{type}} : object : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Type of system to configure, e.g., air handling unit, chilled water plant.
\item[] Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{DUlineblock}

\sphinxstyleemphasis{required} : \sphinxcode{\sphinxupquote{{[}\$id, description, value{]}}}
\end{quote}

\sphinxcode{\sphinxupquote{subtype}} : object : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Subtype of system, e.g., for an air handling unit: variable air volume or dedicated outdoor air.
\item[] Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{DUlineblock}

\sphinxstyleemphasis{required} : \sphinxcode{\sphinxupquote{{[}\$id, description, widget, value{]}}}
\end{quote}

\sphinxcode{\sphinxupquote{name}} : object : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Name of the component. Must be stored in the Modelica annotation \sphinxcode{\sphinxupquote{defaultComponentName}}.
\item[] Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{DUlineblock}

\sphinxstyleemphasis{required} : \sphinxcode{\sphinxupquote{{[}\$id, description, widget, value{]}}}
\end{quote}

\sphinxcode{\sphinxupquote{fluid\_paths}} : array : required
\begin{quote}

\sphinxstyleemphasis{items} : object

\begin{DUlineblock}{0em}
\item[] Definition of all \sphinxstyleemphasis{main fluid paths} of the model, see \hyperref[\detokenize{requirements:sec-heuristic}]{Section \ref{\detokenize{requirements:sec-heuristic}}}.
\item[] Object defined as follows.
\end{DUlineblock}

\sphinxstyleemphasis{required} : \sphinxcode{\sphinxupquote{{[}\$id, direction, medium{]}}}
\begin{quote}

\sphinxcode{\sphinxupquote{\$id}} : string : required
\begin{quote}

Unique string identifier starting with \sphinxcode{\sphinxupquote{\#}}.
\end{quote}

\sphinxcode{\sphinxupquote{direction}} : string : required
\begin{quote}

\sphinxstyleemphasis{enum} : \sphinxcode{\sphinxupquote{{[}"north", "south", "east", "west"{]}}}

Direction indicating the order in which the components must be connected along the path.
\end{quote}

\sphinxcode{\sphinxupquote{medium}} : string : required
\begin{quote}

Common medium for that fluid path and all derived paths, e.g., \sphinxcode{\sphinxupquote{"Buildings.Media.Air"}}
\end{quote}
\end{quote}
\end{quote}

\sphinxcode{\sphinxupquote{icon}} : string : required
\begin{quote}

Path to icon file.
\end{quote}

\sphinxcode{\sphinxupquote{diagram}} : object : required
\begin{quote}

Size of the diagram layout.

Object defined as follows.

\sphinxcode{\sphinxupquote{configuration}} : array : required
\begin{quote}

\sphinxstyleemphasis{items} : integer

Array on length 2, providing the number of lines and columns of the simplified grid layout.
\end{quote}

\sphinxcode{\sphinxupquote{model}} : array : required
\begin{quote}

\sphinxstyleemphasis{items} : array

Array on length 2 providing the coordinates tuples of two opposite corners of the diagram rectangular layout.
\begin{quote}

\sphinxstyleemphasis{items} : integer

Array on length 2 providing the coordinates of one corner of the diagram rectangular layout.
\end{quote}
\end{quote}
\end{quote}

\sphinxcode{\sphinxupquote{equipment}} : array : optional
\begin{quote}

\sphinxstyleemphasis{items} : object

Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{quote}

\sphinxcode{\sphinxupquote{controls}} : array : optional
\begin{quote}

\sphinxstyleemphasis{items} : object

Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{quote}

\sphinxcode{\sphinxupquote{dependencies}} : array : optional
\begin{quote}

\sphinxstyleemphasis{items} : object

Object defined as {\hyperref[\detokenize{requirements:elementary-object}]{\sphinxcrossref{elementary object}}}.
\end{quote}
\end{quote}
\phantomsection\label{\detokenize{requirements:elementary-object}}
\sphinxstylestrong{Elementary Object Definition}
\begin{quote}

\sphinxcode{\sphinxupquote{\$id}} : string : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Unique string identifier.
\item[] Used for referencing the object properties in other configuration objects: references are prefixed with \sphinxcode{\sphinxupquote{\#}} in the examples, e.g., \sphinxcode{\sphinxupquote{\#id\_value.property}}.
\item[] If the object has a \sphinxcode{\sphinxupquote{declaration}} field, the name of the declared component is the value of \sphinxcode{\sphinxupquote{\$id}}.
\item[] Must be suffixed with brackets e.g. \sphinxcode{\sphinxupquote{{[}2{]}}} in case of array variables.
\end{DUlineblock}
\end{quote}

\sphinxcode{\sphinxupquote{description}} : string : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Descriptive string.
\item[] If the object has a \sphinxcode{\sphinxupquote{declaration}} field, the descriptive string appends the component declaration in the Modelica source file (referred to as \sphinxstyleemphasis{comment} in \sphinxstyleemphasis{\S{}4.4.1 Syntax and Examples of Component Declarations} of \sphinxcite{bibliography:modelica2017}).
\end{DUlineblock}
\end{quote}

\sphinxcode{\sphinxupquote{enabled}} : boolean, string (C) : optional, default \sphinxcode{\sphinxupquote{true}}
\begin{quote}

Indicates if the object must be used or not. If not, the UI does not display the corresponding widget, no modification to the model is done and the object field \sphinxcode{\sphinxupquote{value}} is assigned its default value.
\end{quote}

\sphinxcode{\sphinxupquote{widget}} : object : optional
\begin{quote}

Object defined as follows.

\sphinxcode{\sphinxupquote{type}} : string : required
\begin{quote}

Type of UI widget.
\end{quote}

\sphinxcode{\sphinxupquote{options}} : array : optional
\begin{quote}

\sphinxstyleemphasis{items} : string

Options to be displayed by certain widgets, e.g., dropdown menu.
\end{quote}

\sphinxcode{\sphinxupquote{options.enabled}} : array : optional
\begin{quote}

\sphinxstyleemphasis{items} : boolean, string (C)

Indicates which option can be selected by the user. Must be the same size as \sphinxcode{\sphinxupquote{widget.options}}.
\end{quote}
\end{quote}

\sphinxcode{\sphinxupquote{value}} : string (C), number, boolean, null : required
\begin{quote}

{[}\sphinxstyleemphasis{enum} : \sphinxcode{\sphinxupquote{widget.options}} (if provided){]}

\begin{DUlineblock}{0em}
\item[] Value of the object (default value prior to user input).
\item[] May be provided as a literal expression in which all literal references to object properties (prefixed with \sphinxcode{\sphinxupquote{\#}}) must be replaced by their actual value.
\end{DUlineblock}
\end{quote}

\sphinxcode{\sphinxupquote{unit}} : string : optional
\begin{quote}

Unit of the value. Must be displayed in the UI.
\end{quote}

\sphinxcode{\sphinxupquote{declaration}} : array, string (C), null : optional
\begin{quote}

{[}\sphinxstyleemphasis{items} : string (C){]}

Any valid Modelica declaration(*) (component or parameter) or an array of those that has the same size as \sphinxcode{\sphinxupquote{widget.options}} if the latter is provided (in which case the elements of \sphinxcode{\sphinxupquote{declaration}} get mapped with the elements of \sphinxcode{\sphinxupquote{widget.options}} based on their indices).

\begin{sphinxadmonition}{note}{Note:}
(*) The name of the instance is not included in the declaration but provided with the \sphinxcode{\sphinxupquote{\$id}} entry: it must be inserted between the class reference and the optional parameters of the instance (specified within parenthesis).

If one option requires multiple declarations, the first one should typically be specified here and the other ones as dependencies.
\end{sphinxadmonition}
\end{quote}

\sphinxcode{\sphinxupquote{placement}} : array, string (C) : optional
\begin{quote}

{[}\sphinxstyleemphasis{items} : array, integer{]}
\begin{quote}

{[}\sphinxstyleemphasis{items} : integer{]}
\end{quote}

\begin{DUlineblock}{0em}
\item[] Placement of the component icon provided in simplified grid coordinates \sphinxcode{\sphinxupquote{{[}line, column{]}}} to be mapped with the model diagram coordinates.
\item[] Can be an array of arrays where the main array must have the same size as \sphinxcode{\sphinxupquote{widget.options}} if the latter is provided (in which case the elements of \sphinxcode{\sphinxupquote{placement}} get mapped with the elements of \sphinxcode{\sphinxupquote{widget.options}} based on their indices).
\end{DUlineblock}
\end{quote}

\sphinxcode{\sphinxupquote{connect}} : object : optional
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Data required to generate the connect equations involving the connectors of the component, see \hyperref[\detokenize{requirements:sec-fluid-connectors}]{Section \ref{\detokenize{requirements:sec-fluid-connectors}}}.
\item[] Object defined as follows.
\end{DUlineblock}

\sphinxcode{\sphinxupquote{type}} : string : optional, default \sphinxcode{\sphinxupquote{path}}
\begin{quote}

\sphinxstyleemphasis{enum} : \sphinxcode{\sphinxupquote{{[}"path", "tags", "explicit"{]}}}

Type of connection logic.
\end{quote}

\sphinxcode{\sphinxupquote{value}} : string (C), object : required
\begin{quote}

\begin{DUlineblock}{0em}
\item[] If \sphinxcode{\sphinxupquote{type == "path"}}: fluid path (string) that must be used to generate the tags in case of two connectors only. It must not be used if the component has more than two connectors or a non standard connectors scheme (different from one instance of \sphinxcode{\sphinxupquote{Modelica.Fluid.Interfaces.FluidPort\_a}} and one instance of \sphinxcode{\sphinxupquote{Modelica.Fluid.Interfaces.FluidPort\_b}}).
\item[] If \sphinxcode{\sphinxupquote{type == "tags"}}: object providing for each connector (referenced by its instance name) the tag to be applied.
\item[] If \sphinxcode{\sphinxupquote{type == "explicit"}}: object providing for each connector (referenced by instance name) the connector to be connected to, using explicit names e.g. \sphinxcode{\sphinxupquote{fanSup.port\_a}}.
\end{DUlineblock}
\end{quote}
\end{quote}

\sphinxcode{\sphinxupquote{annotation}} : array, string (C), null : optional
\begin{quote}

{[}\sphinxstyleemphasis{items} : string (C){]}

Any valid Modelica annotation or an array of those which must have the same size as \sphinxcode{\sphinxupquote{widget.options}} if the latter is provided (in which case the elements of \sphinxcode{\sphinxupquote{annotation}} get mapped with the elements of \sphinxcode{\sphinxupquote{widget.options}} based on their indices).
\end{quote}

\sphinxcode{\sphinxupquote{protected}} : boolean : optional, default \sphinxcode{\sphinxupquote{false}}
\begin{quote}

\begin{DUlineblock}{0em}
\item[] Indicates if the declaration should be public or protected.
\item[] All protected declarations must be grouped together at the end of the declaration section in the Modelica class (to avoid multiple \sphinxcode{\sphinxupquote{protected}} and \sphinxcode{\sphinxupquote{public}} specifiers in the source file).
\end{DUlineblock}
\end{quote}

\sphinxcode{\sphinxupquote{symbol\_path}} : string (C) : optional
\begin{quote}

Path of the SVG file containing the engineering symbol of the component. This is needed for the schematics export functionality, see \hyperref[\detokenize{requirements:sec-documentation-export}]{Section \ref{\detokenize{requirements:sec-documentation-export}}}. That path is specified by the template developer and not in the class definition because the same class can be used to represent different equipment parts e.g. a flow resistance model can be used to represent either a filter (SVG symbol needed) or a duct section (no SVG symbol needed).
\end{quote}

\sphinxcode{\sphinxupquote{icon\_transformation}} : string (C) : optional
\begin{quote}

Graphical transformation that must be applied to the component icon e.g. \sphinxcode{\sphinxupquote{"flipHorizontal"}}.
\end{quote}
\end{quote}

An example of the resulting data structure is provided in annex, see \hyperref[\detokenize{annex:sec-annex-json}]{Section \ref{\detokenize{annex:sec-annex-json}}}.


\subsubsection{Persisting Data}
\label{\detokenize{requirements:persisting-data}}\label{\detokenize{requirements:sec-persisting-data}}
\sphinxstylestrong{Path of the Configuration File}

The path (relative to the library entry path, see \sphinxstyleemphasis{Path discovery} in \hyperref[\detokenize{requirements:tab-gui-func}]{Table \ref{\detokenize{requirements:tab-gui-func}}}) must be stored in a hierarchical vendor annotation at the model level e.g. \sphinxcode{\sphinxupquote{\_\_Linkage(path="modelica://Buildings.Configuration.AHU")}}.

\sphinxstylestrong{Configuration Objects}

The \sphinxcode{\sphinxupquote{value}} of all objects must be stored with their \sphinxcode{\sphinxupquote{\$id}} in a serialized format within a hierarchical vendor annotation at the model level. (This is done at the model level since some configuration data may be linked to some model declarations indirectly using dependencies so annotations at the declaration level would not cover all use cases.)

This is especially needed so that the references to the configuration data in the object declarations persist when saving and loading a model. Unless specified as \sphinxcode{\sphinxupquote{final}} those references may be overwritten by the user. When loading a model the configuration widget must parse the \sphinxcode{\sphinxupquote{\$id}} and \sphinxcode{\sphinxupquote{value}} of the stored configuration data and reconstruct the corresponding model declarations using the configuration file (and interpreting the references prefixed by \sphinxcode{\sphinxupquote{\#}}). Those declarations are compared to the ones present in the model: if they differ, the ones in the model take precedence.

\sphinxstylestrong{Engineering Symbol SVG File path}

The path (\sphinxcode{\sphinxupquote{symbol\_path}} in {\hyperref[\detokenize{requirements:configuration-data}]{\sphinxcrossref{Configuration data}}}) is stored in a vendor annotation at the declaration level e.g. \sphinxcode{\sphinxupquote{annotation(\_\_Linkage(symbol\_path="value of symbol\_path"))}}.


\subsection{Fluid Connectors}
\label{\detokenize{requirements:fluid-connectors}}\label{\detokenize{requirements:sec-fluid-connectors}}
\begin{sphinxadmonition}{warning}{Warning:}
This paragraph proposes an algorithm that may be used to support the generation of \sphinxcode{\sphinxupquote{connect}} statements between fluid connectors. This part of the specification is not hard and fast, we are rather trying to illustrate a possible implementation path. Alternative approaches are welcome but they must at least provide the same level of functionalities as the proposed approach and meet the minimum requirements that are expressed.
\end{sphinxadmonition}

The fluid connections (\sphinxcode{\sphinxupquote{connect}} equations involving two fluid connectors) is generated based on either:
\begin{itemize}
\item {} 
an explicit connection logic relying on one\sphinxhyphen{}to\sphinxhyphen{}one relationships between connectors (see \hyperref[\detokenize{requirements:sec-explicit}]{Section \ref{\detokenize{requirements:sec-explicit}}}) or,

\item {} 
a heuristic connection logic (see \hyperref[\detokenize{requirements:sec-heuristic}]{Section \ref{\detokenize{requirements:sec-heuristic}}}) based on:
\begin{itemize}
\item {} 
the coordinates of the components in the diagram layout, i.e., after converting the coordinates provided relatively to the simplified grid,

\item {} 
a tag applied to the fluid connectors (or fluid ports) of the components.

\end{itemize}

\end{itemize}


\subsubsection{Explicit Connection Logic}
\label{\detokenize{requirements:explicit-connection-logic}}\label{\detokenize{requirements:sec-explicit}}
In certain cases it may be convenient to specify explicitly a one\sphinxhyphen{}to\sphinxhyphen{}one connection scheme between the connectors of the model, for instance a differential pressure sensor to be connected with the outlet port of a fan model and a port of a fluid source providing the reference pressure.

That logic is activated at the component level by the keyword \sphinxcode{\sphinxupquote{connect.type == "explicit"}}.

The user provides for each connector the name of the component instance and connector instance to be connected to e.g. \sphinxcode{\sphinxupquote{"port\_1": "component1.connector2}}.


\subsubsection{Heuristic Connection Logic}
\label{\detokenize{requirements:heuristic-connection-logic}}\label{\detokenize{requirements:sec-heuristic}}
That logic relies on connectors tagging which supports two modes.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Default mode (\sphinxcode{\sphinxupquote{connect.type == "path"}} or \sphinxcode{\sphinxupquote{null}})
\begin{itemize}
\item {} 
By default an instance of \sphinxcode{\sphinxupquote{Modelica.Fluid.Interfaces.FluidPort\_a}} (resp. \sphinxcode{\sphinxupquote{Modelica.Fluid.Interfaces.FluidPort\_b}}) must be tagged with the suffix \sphinxcode{\sphinxupquote{inlet}} (resp. \sphinxcode{\sphinxupquote{outlet}}).

\item {} 
The tag prefix is provided at the component level to specify the fluid path, for instance \sphinxcode{\sphinxupquote{air\_supply}} or \sphinxcode{\sphinxupquote{air\_return}}.

\item {} 
The fluid connectors are then tagged by concatenating the previous strings, for instance \sphinxcode{\sphinxupquote{air\_supply\_inlet}} or \sphinxcode{\sphinxupquote{air\_return\_outlet}}.

\end{itemize}

\item {} 
Detailed mode (\sphinxcode{\sphinxupquote{connect.type == "tags"}})
\begin{itemize}
\item {} 
An additional mechanism is required to allow tagging each fluid port individually. Typically for a three way valve, the bypass port should be on a different fluid path than the inlet and outlet ports see \hyperref[\detokenize{requirements:linkage-connect-3wv}]{Fig.\@ \ref{\detokenize{requirements:linkage-connect-3wv}}}. Hence we need a mapping dictionary at the connector level which, if provided, takes precedence on the default logic specified above.

\item {} 
Furthermore a fluid connector may be connected to more than one other fluid connector (fork configuration). To support that feature the concept of \sphinxstyleemphasis{derived path} is introduced: if \sphinxcode{\sphinxupquote{fluid\_path}} is the name of a fluid path, each fluid path named \sphinxcode{\sphinxupquote{/\textasciicircum{}fluid\_path\_((?!\_).)*\$/gm}} is considered a \sphinxstyleemphasis{derived path}. The original (derived from) path is the \sphinxstyleemphasis{parent path}. A path with no parent path is referred to as \sphinxstyleemphasis{main path}.

For instance in case of a three way valve the mapping dictionary may be:

\sphinxcode{\sphinxupquote{\{"port\_1": "hotwater\_return\_inlet", "port\_2": "hotwater\_return\_outlet", "port\_3": "hotwater\_supply\_bypass\_inlet"\}}} where \sphinxcode{\sphinxupquote{hotwater\_supply\_bypass}} is a derived path from \sphinxcode{\sphinxupquote{hotwater\_supply}}.

\end{itemize}

\end{enumerate}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_connect_3wv}.pdf}
\caption{Example of the connection scheme for a three\sphinxhyphen{}way valve. The first diagram does not include an explicit model of the fluid junction whereas the second does (and represents the highly recommended modeling approach). This example illustrates how the fluid connection logic allows for both modeling approaches. In the first case the bypass and direct branches are derived paths from \sphinxcode{\sphinxupquote{fluid\_path0}} which consists only in one connector. In the second case they are different main paths, the bypass branch having a different direction than the direct branch (the user could also use an “explicit” connection logic to avoid the definition of an additional main fluid path).}\label{\detokenize{requirements:linkage-connect-3wv}}\end{figure}

The conversion script throws an exception if an instantiated class has \sphinxcode{\sphinxupquote{connect.type != "explicit"}} and some fluid ports that cannot be tagged nor connected with the previous logic e.g. non default names and no (or incomplete) mapping dictionary provided.
Once the tagging is resolved for all fluid connectors of the instantiated objects with \sphinxcode{\sphinxupquote{connect.type != "explicit"}}, the connector tags are stored in a list, furthered referred to as “tagged connectors list”.
All object names in that list thus reference instantiated objects with fluid ports that have to be connected to each other.

To build the full connection set, the direction (north, south, east, west) along which the objects must be connected needs to be provided for all main (not derived) fluid paths.

\begin{sphinxadmonition}{note}{Note:}
The direction (as well as the fluid medium) of a derived path are inherited from the parent path.

Modelica \sphinxcode{\sphinxupquote{connect}} construct is symmetric so at first glance only the vertical / horizontal direction of a fluid path seems enough. However the actual orientation along the fluid path is needed in order to identify the start and end connectors, see below.
\end{sphinxadmonition}

The connection logic is then as follows:
\begin{itemize}
\item {} 
List all the different fluid paths in the tagged connectors list as obtained by truncating \sphinxcode{\sphinxupquote{\_inlet}} and \sphinxcode{\sphinxupquote{\_outlet}} from each connector name. Get the direction of the main fluid paths in the configuration data and finally reconstruct the tree structure of the fluid paths based on their names:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
└── fluid\PYGZus{}path0 (direction: east): [connectors list]
  ├── fluid\PYGZus{}path0\PYGZus{}0 (inherited direction: east): [connectors list]
  └── fluid\PYGZus{}path0\PYGZus{}1 (inherited direction: east): [connectors list]
    ├── fluid\PYGZus{}path0\PYGZus{}1\PYGZus{}0 (inherited direction: east): [connectors list]
    └── fluid\PYGZus{}path0\PYGZus{}1\PYGZus{}1 (inherited direction: east): [connectors list]
├── fluid\PYGZus{}path1 (direction: west): [connectors list]
├── fluid\PYGZus{}path3 (direction: north): [connectors list]
└── fluid\PYGZus{}path4 (direction: south): [connectors list]
\end{sphinxVerbatim}

\item {} 
For each fluid path:
\begin{itemize}
\item {} 
Order all the connectors in the connectors list according to the direction of the fluid path and based on the position of the corresponding \sphinxstyleemphasis{objects} (not connectors) with the constraint that for each object \sphinxcode{\sphinxupquote{inlet}} has to be listed first and \sphinxcode{\sphinxupquote{outlet}} last.

\item {} 
For each derived path find the start and end connectors as described hereunder and prepend / append the connectors list.
\begin{itemize}
\item {} 
If the first (resp. last) connector in the ordered list is an outlet (resp. inlet), it is the start (resp. end) connector. (Note that the reciprocal is not true: a start port can be either an inlet or an outlet see \hyperref[\detokenize{requirements:linkage-connect-multi}]{Fig.\@ \ref{\detokenize{requirements:linkage-connect-multi}}}.)

\item {} 
Otherwise the start (resp. end) connector is the outlet (resp. inlet) connector of the object in the parent path placed immediately before (resp. after) the object corresponding to the first (resp. last) connector \textendash{} where before and after are relative to the direction and orientation of the fluid path (which are the same for the parent path).

\end{itemize}

\item {} 
For each \sphinxstyleemphasis{parent path} split the path into several \sphinxstyleemphasis{sub paths} whenever a connector corresponds to the start or end port of a derived path.

\item {} 
Throw an exception if one of the following rules is not verified:
\begin{itemize}
\item {} 
Derived paths must start \sphinxstyleemphasis{or} end with a connector from a parent path.

\item {} 
Each branch of a fork must be a derived path, it cannot belong to the parent path: so no object from the parent path can be positioned between the objects corresponding to the first and last connector of any derived path.

\end{itemize}

\item {} 
Generate the \sphinxcode{\sphinxupquote{connect}} equations by iterating on the ordered list of connectors and generate the connection path and the corresponding graphical annotation. The only valid connection along a fluid path is \sphinxcode{\sphinxupquote{outlet}} with \sphinxcode{\sphinxupquote{inlet}}.

\item {} 
Populate the \sphinxcode{\sphinxupquote{iconTransformation}} annotation of each outside connector instantiated as a dependency so that, in the icon layer, they belong to the same border (top, left, bottom, right) as in the diagram layer and be evenly positioned considering the icon’s dimensions. The bus connector is an exception and must always be positioned at the top center of the icon.

\end{itemize}

\end{itemize}

That logic implies that within the same fluid path, objects are connected in one given direction only: to represent a fluid loop (graphically) at least two fluid paths must be defined, typically \sphinxcode{\sphinxupquote{supply}} and \sphinxcode{\sphinxupquote{return}}.

\hyperref[\detokenize{requirements:linkage-connect-multi}]{Fig.\@ \ref{\detokenize{requirements:linkage-connect-multi}}} to \hyperref[\detokenize{requirements:linkage-connect-duct}]{Fig.\@ \ref{\detokenize{requirements:linkage-connect-duct}}} further illustrate the connection logic on different test cases.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_connect_multi}.pdf}
\caption{Connection scheme with nested fluid junctions not modeled explicitly (using derived paths)}\label{\detokenize{requirements:linkage-connect-multi}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_connect_multi_exp}.pdf}
\caption{Connection scheme with nested fluid junctions modeled explicitly (recommended modeling approach)}\label{\detokenize{requirements:linkage-connect-multi-exp}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_connect_duct}.pdf}
\caption{Connection scheme with fluid branches with different directions e.g. VAV duct system. Here a flow splitter is used to start several main fluid paths with a vertical connection direction.}\label{\detokenize{requirements:linkage-connect-duct}}\end{figure}


\subsection{Signal Connectors}
\label{\detokenize{requirements:signal-connectors}}\label{\detokenize{requirements:sec-signal-connectors}}
\begin{sphinxadmonition}{warning}{Warning:}
This paragraph proposes an algorithm that may be used to support the generation of \sphinxcode{\sphinxupquote{connect}} statements between signal (or block) connectors. This part of the specification is not hard and fast, we are rather trying to illustrate a possible implementation path. Alternative approaches are welcome but they must at least provide the same level of functionalities as the proposed approach and meet the minimum requirements that are expressed.
\end{sphinxadmonition}


\subsubsection{General Principles}
\label{\detokenize{requirements:general-principles}}
Generating the \sphinxcode{\sphinxupquote{connect}} equations for signal variables relies on:
\begin{itemize}
\item {} 
a (fuzzy) string matching principle applied to the names of the connector variables and their components e.g. \sphinxcode{\sphinxupquote{com.y}} for the output connector \sphinxcode{\sphinxupquote{y}} of the component \sphinxcode{\sphinxupquote{com}},

\item {} 
a so\sphinxhyphen{}called \sphinxstyleemphasis{control bus} which has the type of an \sphinxstyleemphasis{expandable connector}, see \sphinxstyleemphasis{\S{}9.1.3 Expandable Connectors} in \sphinxcite{bibliography:modelica2017}.

\end{itemize}

The following features of the expandable connectors are leveraged. They are illustrated with minimal examples in annex, see \hyperref[\detokenize{annex:sec-annex-bus-example}]{Section \ref{\detokenize{annex:sec-annex-bus-example}}}.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
All components in an expandable connector are seen as connector instances even if they are not declared as such. In comparison to a non expandable connector, that means that each variable (even of type \sphinxcode{\sphinxupquote{Real}}) can be connected i.e. be part of a \sphinxcode{\sphinxupquote{connect}} equation.

\begin{sphinxadmonition}{note}{Note:}
Connecting a non connector variable to a connector variable with \sphinxcode{\sphinxupquote{connect(non\_connector\_var, connector\_var)}} yields a warning but not an error in Dymola. It is considered bad practice though and a standard equation should be used in place \sphinxcode{\sphinxupquote{non\_connector\_var = connector\_var}}.

Using a \sphinxcode{\sphinxupquote{connect}} equation allows to draw a connection line which makes the model structure explicit to the user. Furthermore it avoids mixing \sphinxcode{\sphinxupquote{connect}} equations and standard equations within the same equation set, which has been adopted as a best practice in the Modelica Buildings library.
\end{sphinxadmonition}

\item {} 
The causality (input or output) of each variable inside an expandable connector is not predefined but rather set by the \sphinxcode{\sphinxupquote{connect}} equation where the variable is first being used. For instance when the variable of an expandable connector is first connected to an inside connector \sphinxcode{\sphinxupquote{Modelica.Blocks.Interfaces.RealOutput}} it gets the same causality i.e. output. The same variable can then be connected to another inside connector  \sphinxcode{\sphinxupquote{Modelica.Blocks.Interfaces.RealInput}}.

\item {} 
Potentially present but not connected variables are eventually considered as undefined i.e. a tool may remove them or set them to the default value (Dymola treat them as not declared: they are not listed in \sphinxcode{\sphinxupquote{dsin.txt}}): all variables need not be connected so the control bus does not have to be reconfigured depending on the model structure.

\item {} 
The variables set of a class of type expandable connector is augmented whenever a new variable gets connected to any \sphinxstyleemphasis{instance} of the class. Though that feature is not needed by the configuration widget (we will have a predefined control bus with declared variables), it is needed to allow the user further modifying the control sequence. Adding new control variables is simply done by connecting them to the control bus.

\item {} 
Expandable connectors can be used in arrays, as any other Modelica type. A typical use case is the connection of control input signals from a set of terminal units to a supervisory controller at the AHU or at the plant level. This use case has been validated on minimal examples in \hyperref[\detokenize{annex:sec-annex-bus-array}]{Section \ref{\detokenize{annex:sec-annex-bus-array}}}.

\end{enumerate}


\subsubsection{Generating Connections by Approximate String Matching}
\label{\detokenize{requirements:generating-connections-by-approximate-string-matching}}
\begin{sphinxadmonition}{note}{Note:}
The module implementing the string matching algorithm will be developed by LBL.
\end{sphinxadmonition}

To support automatic connections of signal variables a predefined control bus will be defined for each type of system (e.g. AHU, CHW plant) with a set of predeclared variables. The names of the variables must allow a one\sphinxhyphen{}to\sphinxhyphen{}one correspondence between:
\begin{itemize}
\item {} 
the control sequence input variables and the outputs of the equipment model e.g. sensed quantities and actuators returned positions,

\item {} 
the control sequence output variables and the inputs of the equipment model e.g. actuators commanded positions.

\end{itemize}

Thus the control bus variables are used as “gateways” to stream values between the controlled system and the controller system.

However an exact string matching is not conceivable. An approximate (or fuzzy) string matching algorithm must be used instead. Such an algorithm has been tested in the case of an advanced control sequence implementation in CDL (\sphinxcode{\sphinxupquote{Buildings.Controls.OBC.ASHRAE.G36\_PR1.AHUs.MultiZone.VAV.Controller}}): see \hyperref[\detokenize{requirements:code-string-match}]{Listing \ref{\detokenize{requirements:code-string-match}}} and results in \hyperref[\detokenize{requirements:fig-string-match}]{Fig.\@ \ref{\detokenize{requirements:fig-string-match}}}. The main conclusions of that test are the following:
\begin{itemize}
\item {} 
Strict naming conventions solve most of the mismatch cases with a satisfying confidence (end score \textgreater{} 60).

\item {} 
There is still a need to specify a convention to determine which array element should be connected to a scalar variable.

\item {} 
There is one remaining mismatch (\sphinxcode{\sphinxupquote{busAhu.TZonHeaSet}}) for which a logic consisting in using only the variable name if it is descriptive enough (test on length of suffix of standard variables names) and the initial matching score is low (below 50).

\end{itemize}
\sphinxSetupCaptionForVerbatim{Example of a Python function used for fuzzy string matching}
\def\sphinxLiteralBlockLabel{\label{\detokenize{requirements:code-string-match}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
 \PYG{k+kn}{from} \PYG{n+nn}{fuzzywuzzy} \PYG{k+kn}{import} \PYG{n}{fuzz}
 \PYG{k+kn}{from} \PYG{n+nn}{fuzzywuzzy} \PYG{k+kn}{import} \PYG{n}{process}
 \PYG{k+kn}{import} \PYG{n+nn}{itertools} \PYG{k}{as} \PYG{n+nn}{it}
 \PYG{k+kn}{import} \PYG{n+nn}{re}


 \PYG{k}{def} \PYG{n+nf}{return\PYGZus{}best}\PYG{p}{(}\PYG{n}{string}\PYG{p}{,} \PYG{n}{choices}\PYG{p}{,} \PYG{n}{sys\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ahu}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
     \PYG{c+c1}{\PYGZsh{} Constrain array to array and scalar (or array element) to scalar.}
     \PYG{c+c1}{\PYGZsh{} Need to specify a logic for tagging scalar variables that should be connected to array elements e.g. \PYGZsq{}*\PYGZus{}zon*.y\PYGZsq{}.}
     \PYG{c+c1}{\PYGZsh{} But allow a single array element to be connected to a scalar variable: not bool(re.search(\PYGZsq{}\PYGZbs{}[\PYGZbs{}d+\PYGZbs{}]\PYGZsq{}, string))}
     \PYG{k}{if} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{re}\PYG{o}{.}\PYG{n}{search}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{[.+}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{]|\PYGZus{}zon.*}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{)}\PYG{p}{)} \PYG{o+ow}{and} \PYG{o+ow}{not} \PYG{n+nb}{bool}\PYG{p}{(}\PYG{n}{re}\PYG{o}{.}\PYG{n}{search}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{[}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{d+}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
         \PYG{n}{choices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{el} \PYG{k}{for} \PYG{n}{el} \PYG{o+ow}{in} \PYG{n}{choices} \PYG{k}{if} \PYG{n}{re}\PYG{o}{.}\PYG{n}{search}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{[.+}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{el}\PYG{p}{)}\PYG{p}{]}
         \PYG{c+c1}{\PYGZsh{} Replace [.*] by [:]}
         \PYG{n}{string} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{[.*}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{[:]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{,} \PYG{n}{flags}\PYG{o}{=}\PYG{n}{re}\PYG{o}{.}\PYG{n}{I}\PYG{p}{)}
         \PYG{n}{string} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}zon.*}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{[:].}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{,} \PYG{n}{flags}\PYG{o}{=}\PYG{n}{re}\PYG{o}{.}\PYG{n}{I}\PYG{p}{)}
     \PYG{k}{else}\PYG{p}{:}
         \PYG{n}{choices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{el} \PYG{k}{for} \PYG{n}{el} \PYG{o+ow}{in} \PYG{n}{choices} \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{re}\PYG{o}{.}\PYG{n}{search}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{[.+}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{el}\PYG{p}{)}\PYG{p}{]}

     \PYG{c+c1}{\PYGZsh{} Replace pre by p and tem by t.}
     \PYG{n}{string} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{pre}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{P}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{,} \PYG{n}{flags}\PYG{o}{=}\PYG{n}{re}\PYG{o}{.}\PYG{n}{I}\PYG{p}{)}
     \PYG{n}{string} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tem}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{T}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{,} \PYG{n}{flags}\PYG{o}{=}\PYG{n}{re}\PYG{o}{.}\PYG{n}{I}\PYG{p}{)}

     \PYG{c+c1}{\PYGZsh{} Do not consider controller and bus component names.}
     \PYG{c+c1}{\PYGZsh{} Remark: has only little impact.}
     \PYG{n}{string} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZca{}(con|bus)}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{sys\PYGZus{}type}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{string}\PYG{p}{)}
     \PYG{n}{choices} \PYG{o}{=} \PYG{p}{[}\PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZca{}(con|bus)}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{.}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{sys\PYGZus{}type}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{c}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c} \PYG{o+ow}{in} \PYG{n}{choices}\PYG{p}{]}

     \PYG{c+c1}{\PYGZsh{} Perform comparison.}
     \PYG{n}{res} \PYG{o}{=} \PYG{n}{process}\PYG{o}{.}\PYG{n}{extract}\PYG{p}{(}\PYG{n}{string}\PYG{p}{,} \PYG{n}{choices}\PYG{p}{,} \PYG{n}{limit}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{scorer}\PYG{o}{=}\PYG{n}{fuzz}\PYG{o}{.}\PYG{n}{token\PYGZus{}sort\PYGZus{}ratio}\PYG{p}{)}

     \PYG{k}{return} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{it}\PYG{o}{.}\PYG{n}{chain}\PYG{p}{(}\PYG{o}{*}\PYG{n}{res}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}





\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{string_match}.pdf}
\caption{Fuzzy string matching test case \textendash{} G36 VAV AHU Controller.
\sphinxcode{\sphinxupquote{match}} (resp. \sphinxcode{\sphinxupquote{match\_to}}) is the bus variable with the highest matching score when compared to \sphinxcode{\sphinxupquote{Controller variable}} (resp. \sphinxcode{\sphinxupquote{Variable to connect to}}). \sphinxcode{\sphinxupquote{score}} (resp. \sphinxcode{\sphinxupquote{score\_to}}) is the corresponding matching score and       \sphinxcode{\sphinxupquote{sec\_score}} (resp. \sphinxcode{\sphinxupquote{sec\_score\_to}}) is the second highest score. Variables highlighted in red show when the algorithm fails. Rows highlighted in grey show the effect of renaming the variables based on strict naming conventions e.g. quantity first with standard abbreviation, etc.}\label{\detokenize{requirements:fig-string-match}}\end{figure}


\subsubsection{Validation and Additional Requirements}
\label{\detokenize{requirements:validation-and-additional-requirements}}
The use of expandable connectors (control bus) is validated in case of a complex controller, see \hyperref[\detokenize{annex:sec-annex-bus-valid}]{Section \ref{\detokenize{annex:sec-annex-bus-valid}}}.

\begin{sphinxadmonition}{note}{Note:}
Connectors with conditional instances must be connected to the bus variables with the same conditional statement e.g.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{if} \PYG{n}{have\PYGZus{}occSen} \PYG{k+kr}{then}
    \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{nOcc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{numZon}\PYG{p}{],} \PYG{n}{nOcc}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{o}{:}\PYG{n}{numZon}\PYG{p}{])}
\PYG{k+kr}{end} \PYG{k+kr}{if}\PYG{p}{;}
\end{sphinxVerbatim}

With Dymola, bus variables cannot be connected to array connectors without explicitly specifying the indices range.
Using the unspecified \sphinxcode{\sphinxupquote{{[}:{]}}} syntax yields the following translation error.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{Failed} \PYG{n}{to} \PYG{n}{expand} \PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{nOcc}\PYG{p}{[}\PYG{o}{:}\PYG{p}{]} \PYG{p}{(}\PYG{n}{since} \PYG{n}{element} \PYG{n}{does} \PYG{o+ow}{not} \PYG{n}{exist}\PYG{p}{)} \PYG{k+kr}{in} \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{nOcc}\PYG{p}{[}\PYG{o}{:}\PYG{p}{],} \PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{nOcc}\PYG{p}{[}\PYG{o}{:}\PYG{p}{]);}
\end{sphinxVerbatim}

Providing an explicit indices range e.g. \sphinxcode{\sphinxupquote{{[}1:numZon{]}}} like in the previous code snippet only causes a translation warning: Dymola seems to allocate a default dimension of \sphinxstylestrong{20} to the connector, the unused indices (from 3 to 20 in the example hereunder) are then removed since they are not used in the model.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{Warning}\PYG{o}{:} \PYG{n}{The} \PYG{n}{bus}\PYG{o}{\PYGZhy{}}\PYG{k+kr}{input} \PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{n}{matches} \PYG{n}{multiple} \PYG{n}{top}\PYG{o}{\PYGZhy{}}\PYG{n}{level} \PYG{n}{connectors} \PYG{k+kr}{in} \PYG{n}{the} \PYG{n}{connection} \PYG{n}{sets}\PYG{o}{.}

\PYG{n}{Bus}\PYG{o}{\PYGZhy{}}\PYG{n}{signal}\PYG{o}{:} \PYG{n}{ahuI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}

\PYG{n}{Connected} \PYG{n}{bus} \PYG{n}{variables}\PYG{o}{:}
\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{p}{(}\PYG{k+kr}{connect}\PYG{p}{)} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Connector of Real output signal}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{p}{(}\PYG{k+kr}{connect}\PYG{p}{)} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Primary airflow rate to the ventilation zone from the air handler, including   outdoor air and recirculated air}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{p}{(}\PYG{k+kr}{connect}\PYG{p}{)}
\PYG{n}{conAHU}\PYG{o}{.}\PYG{n}{ahuSubBusI}\PYG{o}{.}\PYG{n}{VDis\PYGZus{}flow}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{p}{(}\PYG{k+kr}{connect}\PYG{p}{)}
\end{sphinxVerbatim}

This is a strange behavior in Dymola. On the other hand JModelica:
\begin{itemize}
\item {} 
allows the unspecified \sphinxcode{\sphinxupquote{{[}:{]}}} syntax and,

\item {} 
does not generate any translation warning when explicitly specifying the indices range.

\end{itemize}

JModelica’s behavior seems more aligned with \sphinxcite{bibliography:modelica2017} \sphinxstyleemphasis{\S{}9.1.3 Expandable Connectors} that states: “A non\sphinxhyphen{}parameter array element may be declared with array dimensions “:” indicating that the size is unknown.”
The same logic as JModelica for array variables connections to expandable connectors is required for Linkage.
\end{sphinxadmonition}


\subsubsection{Additional Requirements for the UI}
\label{\detokenize{requirements:additional-requirements-for-the-ui}}\label{\detokenize{requirements:sec-connect-ui-req}}
Based on the previous validation case, \hyperref[\detokenize{requirements:dymola-bus}]{Fig.\@ \ref{\detokenize{requirements:dymola-bus}}} presents the Dymola pop\sphinxhyphen{}up window displayed when connecting the sub\sphinxhyphen{}bus of input control variables to the main control bus.
A similar view of the connections set must be implemented with the additional requirements listed below. That view is displayed in the connections tab of the right panel.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{dymola_bus}.png}
\caption{Dymola pop\sphinxhyphen{}up window when connecting the sub\sphinxhyphen{}bus of input control variables (left) to the main control bus (right) \textendash{} case of outside connectors}\label{\detokenize{requirements:dymola-bus}}\end{figure}

The variables listed immediately after the bus name are either
\begin{itemize}
\item {} 
\sphinxstyleemphasis{declared variables} that are not connected, for instance \sphinxcode{\sphinxupquote{ahuBus.yTest}} (declared as \sphinxcode{\sphinxupquote{Real}} in the bus definition): those variables are only \sphinxstyleemphasis{potentially present} and eventually considered as \sphinxstyleemphasis{undefined} when translating the model (treated by Dymola as if they were never declared) or,

\item {} 
\sphinxstyleemphasis{present variables} i.e. variables that appear in a connect equation, for instance \sphinxcode{\sphinxupquote{ahuSubBusI.TZonHeaSet}}: the icon next to each variable then indicates the causality. Those variables can originally be either declared variables or variables elaborated by the augmentation process for \sphinxstyleemphasis{that instance} of the expandable connector i.e. variables that are declared in another component and connected to the connector’s instance.

\end{itemize}

The variables listed under \sphinxcode{\sphinxupquote{Add variable}} are the remaining \sphinxstyleemphasis{potentially present variables} (in addition to the declared but not connected variables). Those variables are elaborated by the augmentation process for \sphinxstyleemphasis{all instances} of the expandable connector, however they are not connected in that instance of the connector.

In addition to Dymola’s features for handling the bus connections, Linkage requires the following.
\begin{itemize}
\item {} 
Color code to distinguish between
\begin{itemize}
\item {} 
Variables connected only once (within the entire augmentation set): those variables should be listed first and in red color. This is needed so that the user immediately identify which connections are still required for the model to be complete.

\begin{sphinxadmonition}{note}{Note:}
Dymola does not throw any exception when a \sphinxstyleemphasis{declared} bus variable is connected to an input (resp. output) variable but not connected to any other non input (resp. non output) variable. It then uses the default value (0 for \sphinxcode{\sphinxupquote{Real}}) to feed the connected variable.

That is not the case if the variable is not declared i.e. elaborated by augmentation: in that case it has to be connected in a consistent way.

JModelica throws an exception in any case with the message \sphinxcode{\sphinxupquote{The following variable(s) could not be matched to any equation}}.
\end{sphinxadmonition}

\item {} 
Declared variables which are only potentially present (not connected): those variables should be listed last (not first as in Dymola) and in light grey color. That behavior is also closer to \sphinxcite{bibliography:modelica2017} \sphinxstyleemphasis{\S{}9.1.3 Expandable Connectors}: “variables and non\sphinxhyphen{}parameter array elements declared in expandable connectors are marked as only being potentially present. {[}…{]} elements that are only potentially present are not seen as declared.”

\end{itemize}

\item {} 
View the “expanded” connection set of an expandable connector in each level of composition \textendash{} that covers several topics:
\begin{itemize}
\item {} 
The user can view the connection set of a connector simply by selecting it and without having to make an actual connection (as in Dymola).

\item {} 
The user can view the name of the component and connector variable to which the expandable connector’s variables are connected: similar to Dymola’s function \sphinxcode{\sphinxupquote{Find Connection}} accessible by right\sphinxhyphen{}clicking on a connection line.

\item {} 
\begin{DUlineblock}{0em}
\item[] From \sphinxcite{bibliography:modelica2017} \sphinxstyleemphasis{\S{}9.1.3 Expandable Connectors}: “When two expandable connectors are connected, each is augmented with the variables that are only declared in the other expandable connector (the new variables are neither input nor output).”
\item[] That feature is illustrated in the minimal example \hyperref[\detokenize{requirements:bus-minimal}]{Fig.\@ \ref{\detokenize{requirements:bus-minimal}}} where a sub\sphinxhyphen{}bus \sphinxcode{\sphinxupquote{subBus}} with declared variables \sphinxcode{\sphinxupquote{yDeclaredPresent}} and \sphinxcode{\sphinxupquote{yDeclaredNotPresent}} is connected to the declared sub\sphinxhyphen{}bus \sphinxcode{\sphinxupquote{bus.ahuI}} of a bus. \sphinxcode{\sphinxupquote{yDeclaredPresent}} is connected to another variable so it is considered present. \sphinxcode{\sphinxupquote{yDeclaredNotPresent}} is not connected so it is only considered potentially present. Finally \sphinxcode{\sphinxupquote{yNotDeclaredPresent}} is connected but not declared which makes it a present variable. \hyperref[\detokenize{requirements:subbus-outside}]{Fig.\@ \ref{\detokenize{requirements:subbus-outside}}} to \hyperref[\detokenize{requirements:bus-inside}]{Fig.\@ \ref{\detokenize{requirements:bus-inside}}} then show which variables are exposed to the user. In consistency with \sphinxcite{bibliography:modelica2017} the declared variables of \sphinxcode{\sphinxupquote{subBus}} are considered declared variables in \sphinxcode{\sphinxupquote{bus.ahuI}} due to the connect equation between those two instances and they are neither input nor output. Furthermore the present variable \sphinxcode{\sphinxupquote{yNotDeclaredPresent}} appears in \sphinxcode{\sphinxupquote{bus.ahuI}} under \sphinxcode{\sphinxupquote{Add variable}}, i.e., as a potentially present variable whereas it is a present variable in the connected sub\sphinxhyphen{}bus \sphinxcode{\sphinxupquote{subBus}}.
\end{DUlineblock}
\begin{itemize}
\item {} 
This is an issue for the user who will not have the information at the bus level of the connections which are required by the sub\sphinxhyphen{}bus variables e.g. Dymola will allow connecting an output connector to \sphinxcode{\sphinxupquote{bus.ahuI.yDeclaredPresent}} but the translation of the model will fail due to \sphinxcode{\sphinxupquote{Multiple sources for causal signal in the same connection set}}.

\item {} 
Directly connecting variables to the bus (without intermediary sub\sphinxhyphen{}bus) can solve that issue for outside connectors but not for inside connectors, see below.

\end{itemize}

\item {} 
\begin{DUlineblock}{0em}
\item[] Another issue is illustrated \hyperref[\detokenize{requirements:bus-inside}]{Fig.\@ \ref{\detokenize{requirements:bus-inside}}} where the connection to the bus is now made from an outside component for which the bus is considered as an inside connector. Here Dymola only displays declared variables of the bus (but not of the sub\sphinxhyphen{}bus) but without the causality information and even if it is only potentially present (not connected). Present variables of the bus or sub\sphinxhyphen{}bus which are not declared are not displayed. Contrary to Dymola, Linkage requires that the “expanded” connection set of an expandable connector be exposed, independently from the level of composition. That means exposing all the variables of the \sphinxstyleemphasis{augmentation set} as defined in \sphinxcite{bibliography:modelica2017} \sphinxstyleemphasis{9.1.3 Expandable Connectors}. In our example the same information displayed in \hyperref[\detokenize{requirements:subbus-outside}]{Fig.\@ \ref{\detokenize{requirements:subbus-outside}}} for the original sub\sphinxhyphen{}bus should be accessible when displaying the connection set of \sphinxcode{\sphinxupquote{bus.ahuI}} whatever the current status (inside or outside) of the connector \sphinxcode{\sphinxupquote{bus}}. A typical view of the connection set of expandable connectors for Linkage could be:
\end{DUlineblock}


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Typical view of the connection set of expandable connectors \textendash{} visible from outside component (connector is inside), “Present” and “I/O” columns display the connection status over the full augmentation set}\label{\detokenize{requirements:id17}}
\sphinxaftertopcaption
\begin{tabular}[t]{|\X{40}{100}|\X{10}{100}|\X{10}{100}|\X{20}{100}|\X{20}{100}|}
\hline
\sphinxstyletheadfamily 
Variable
&\sphinxstyletheadfamily 
Present
&\sphinxstyletheadfamily 
Declared
&\sphinxstyletheadfamily 
I/O
&\sphinxstyletheadfamily 
Description
\\
\hline
\sphinxstylestrong{bus}
&&&&\\
\hline
\sphinxcode{\sphinxupquote{var1}} (present variable connected only once: red color)
&
x
&
O
&
\(\rightarrow\) \sphinxcode{\sphinxupquote{comp1.var1}}
&
…
\\
\hline
\sphinxcode{\sphinxupquote{var2}}  (present variable connected twice: default color)
&
x
&
O
&
\sphinxcode{\sphinxupquote{comp2.var1}} \(\rightarrow\) \sphinxcode{\sphinxupquote{comp1.var2}}
&
…
\\
\hline
\sphinxcode{\sphinxupquote{var3}} (declared variable not connected: light grey color)
&
O
&
x
&&
…
\\
\hline
\sphinxstyleemphasis{Add variable}
&&&&\\
\hline
\sphinxcode{\sphinxupquote{var4}} (variable elaborated by augmentation from \sphinxstyleemphasis{all instances} of the connector: light grey color)
&
O
&
O
&&
…
\\
\hline
\sphinxstylestrong{subBus}
&&&&\\
\hline
\sphinxcode{\sphinxupquote{var5}} (present variable connected only once: red color)
&
x
&
O
&
\sphinxcode{\sphinxupquote{comp3.var5}} \(\rightarrow\)
&
…
\\
\hline
\sphinxstyleemphasis{Add variable}
&&&&\\
\hline
\sphinxcode{\sphinxupquote{var6}} (variable elaborated by augmentation from \sphinxstyleemphasis{all instances} of the connector: light grey color)
&
O
&
O
&&
…
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}

\end{itemize}

\end{itemize}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=800\sphinxpxdimen]{{bus_minimal}.pdf}
\caption{Minimal example of sub\sphinxhyphen{}bus to bus connection illustrating how the bus variables are exposed in Dymola \textendash{} case of outside connectors}\label{\detokenize{requirements:bus-minimal}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{subbus_outside}.png}
\caption{Sub\sphinxhyphen{}bus variables being exposed in case the sub\sphinxhyphen{}bus is an outside connector}\label{\detokenize{requirements:subbus-outside}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{bus_outside}.png}
\caption{Bus variables being exposed in case the bus is an outside connector}\label{\detokenize{requirements:bus-outside}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{bus_inside}.png}
\caption{Bus variables being exposed in case the bus is an inside connector}\label{\detokenize{requirements:bus-inside}}\end{figure}


\subsection{Control Sequence Configuration}
\label{\detokenize{requirements:control-sequence-configuration}}
In principle the configuration widget as specified previously should allow building custom control sequences based on elementary control blocks (e.g. from the \sphinxhref{https://github.com/lbl-srg/modelica-buildings/tree/master/Buildings/Controls/OBC/CDL}{CDL Library}) and automatically generating connections between those blocks. However
\begin{itemize}
\item {} 
this would require to distinguish between low\sphinxhyphen{}level control blocks (e.g. \sphinxcode{\sphinxupquote{Buildings.Controls.OBC.CDL.Continuous.LimPID}}) composing a system controller \textendash{} which must be connected with direct connect equations and not with expandable connectors variables that are not part of the CDL specification \textendash{} and high\sphinxhyphen{}level control blocks (e.g. \sphinxcode{\sphinxupquote{Buildings.Controls.OBC.ASHRAE.G36\_PR1.AHUs.MultiZone.VAV.Controller}}) \textendash{} which can be connected to other high\sphinxhyphen{}level controllers (e.g. \sphinxcode{\sphinxupquote{Buildings.Controls.OBC.ASHRAE.G36\_PR1.TerminalUnits.Controller}}) using expandable connectors variables (the CDL translation will be done for each high\sphinxhyphen{}level controller individually),

\item {} 
the complexity of some sequences makes it hard to validate the reliability of such an approach without extensive testing.

\end{itemize}

Therefore in practice, and at least for the first version of Linkage, it has been decided to rely on pre\sphinxhyphen{}assembled high\sphinxhyphen{}level control blocks. For each system type (e.g., AHU) one (or a very limited number) of control block(s) should be instantiated by the configuration widget for which the connections can be generated using expandable connectors as described before.

The example of the configuration file for a VAV system in \hyperref[\detokenize{annex:sec-annex-json}]{Section \ref{\detokenize{annex:sec-annex-json}}} illustrates that use case.


\section{Parameters Setting}
\label{\detokenize{requirements:parameters-setting}}\label{\detokenize{requirements:sec-parameters}}
\begin{sphinxadmonition}{note}{Revision Note (11/2020)}

This paragraph is modified to retain only the requirements pertaining to the configuration widget.
\end{sphinxadmonition}


\subsection{Enumeration and Boolean}
\label{\detokenize{requirements:enumeration-and-boolean}}
For parameters of type \sphinxstyleemphasis{enumeration} or \sphinxstyleemphasis{Boolean} a dropdown menu should be displayed and populated by the enumeration items or \sphinxcode{\sphinxupquote{true}} and \sphinxcode{\sphinxupquote{false}}.


\subsection{Validation}
\label{\detokenize{requirements:validation}}
Values entered by the user must be validated \sphinxstyleemphasis{upon submit} against Modelica language specification \sphinxcite{bibliography:modelica2017} and parameter attributes e.g. \sphinxcode{\sphinxupquote{min}}, \sphinxcode{\sphinxupquote{max}}.

A color code is required to identify the fields with incorrect values and the corresponding error message must be displayed on hover.


\section{Documentation Export}
\label{\detokenize{requirements:documentation-export}}\label{\detokenize{requirements:sec-documentation-export}}
The documentation export encompasses three items.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Engineering schematics of the equipment including the controls points

\item {} 
Control points list

\item {} 
Control sequence description

\end{enumerate}

The composition level at which the functionality will typically be used is the same as the one considered for the configuration widget, for instance primary plant, air handling unit, terminal unit, etc. No specific mechanism to guard against an export call at different levels is required.

\hyperref[\detokenize{requirements:screen-schematics-modelica}]{Fig.\@ \ref{\detokenize{requirements:screen-schematics-modelica}}} provides the typical diagram view of the Modelica model generated by the configuration widget and \hyperref[\detokenize{requirements:screen-schematics-output}]{Fig.\@ \ref{\detokenize{requirements:screen-schematics-output}}} mocks up the corresponding documentation that must be exported. The documentation export may consist in three different files but must contain all the material described in the following paragraphs.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{screen_schematics_modelica}.pdf}
\caption{Diagram view of the Modelica model generated by the configuration widget}\label{\detokenize{requirements:screen-schematics-modelica}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{screen_schematics_output}.pdf}
\caption{Mockup of the documentation export}\label{\detokenize{requirements:screen-schematics-output}}\end{figure}


\subsection{Engineering Schematics}
\label{\detokenize{requirements:engineering-schematics}}
Objects of the original model to be included in the schematics export must have a declaration annotation providing the SVG file path for the corresponding engineering symbol e.g. \sphinxcode{\sphinxupquote{annotation(\_\_Linkage(symbol\_path="value of symbol\_path"))}}. That annotation may be
\begin{itemize}
\item {} 
specified in the configuration file, see \sphinxcode{\sphinxupquote{symbol\_path}} in {\hyperref[\detokenize{requirements:configuration-data}]{\sphinxcrossref{Configuration data}}},

\item {} 
specified manually by the user for potentially any instantiated component.

\end{itemize}

\begin{sphinxadmonition}{note}{Note:}
It is expected that Linkage will eventually be used to generate design documents included in the invitation to tender for HVAC control systems. The exported schematics should meet the industry standards and they must allow for further editing in CAD softwares, e.g., AutoCAD®.

Due to geometry discrepancies between Modelica icons and engineering symbols a perfect alignment of the latter is not expected by simply mapping the diagram coordinates of the former to the SVG layout. A mechanism should be developed to automatically correct small alignment defaults.
\end{sphinxadmonition}

For the exported objects
\begin{itemize}
\item {} 
the connectors connected to the control input and output sub\sphinxhyphen{}buses must be split into two groups depending on their type \textendash{} boolean or numeric,

\item {} 
an index tag is then generated based on the object position, from top to bottom and left to right,

\item {} 
eventually connection lines are drawn to link those tags to the four different control points buses (AI, AO, DI, DO). The line must be vertical, with an optional horizontal offset from the index tag to avoid overlapping any other object.

\end{itemize}

SVG is the required output format.

See \hyperref[\detokenize{requirements:screen-schematics-output}]{Fig.\@ \ref{\detokenize{requirements:screen-schematics-output}}} for the typical output of the schematics export process.


\subsection{Control Points List}
\label{\detokenize{requirements:control-points-list}}
Generating the control points list is done by calling a module developed by LBL (ongoing development) which returns an HTML or Word document.


\subsection{Control Sequence Description}
\label{\detokenize{requirements:control-sequence-description}}
Generating the control sequence description is done by calling a \sphinxhref{https://lbl-srg.github.io/modelica-json/}{module developed by LBL} which returns an HTML or Word document.

\begin{sphinxadmonition}{note}{Revision Note (10/2020)}

The paragraphs “Working with Tagged Variables”, “OpenStudio Integration” and “Interface with URBANopt GeoJSON” are removed.
\end{sphinxadmonition}


\section{Licensing}
\label{\detokenize{requirements:licensing}}
The software is developed under funding from the U.S. Department of Energy and the U.S. Government consequently retains certain rights. As such, the U.S. Government has been granted for itself and others acting on its behalf a paid\sphinxhyphen{}up, nonexclusive, irrevocable, worldwide license in the Software to reproduce, distribute copies to the public, prepare derivative works, and perform publicly and display publicly, and to permit other to do so.

The main software components built as part of this development project must be open sourced under BSD 3 or 4\sphinxhyphen{}clause, with possible additions to make it easy to accept improvements. Licensing under GPL or LGPL will not be accepted.

Different licensing options are then envisioned depending on the integration target and the engagement of third\sphinxhyphen{}party developers and distributors. The minimum requirement is that at least one integration target be made available as a free software.
\begin{itemize}
\item {} 
Desktop app

Subscription\sphinxhyphen{}based

\item {} 
Standalone web app
\begin{itemize}
\item {} 
Free account allowing access to Modelica libraries preloaded by default, for instance Modelica Standard and Buildings: the user can only upload and download single Modelica files (not a package).

\item {} 
Pro account allowing access to server storage of Modelica files (packages uploaded and models saved by the user): the user can update the stored libraries and reopen saved models between sessions.

\end{itemize}

\item {} 
Third\sphinxhyphen{}party application embedding

Licensing will depend on the application distribution model.

For OpenStudio there is currently a shift in the \sphinxhref{https://www.openstudio.net/new-future-for-openstudio-application}{licensing strategy}. The specification will be updated to comply with the distribution options after the transition period (no entity has yet announced specific plans to continue support for the OS app).

\end{itemize}


\chapter{Software Architecture}
\label{\detokenize{architecture:software-architecture}}\label{\detokenize{architecture:sec-architecture}}\label{\detokenize{architecture::doc}}
\hyperref[\detokenize{architecture:linkage-architecture-legend}]{Fig.\@ \ref{\detokenize{architecture:linkage-architecture-legend}}} to \hyperref[\detokenize{architecture:linkage-architecture-spa}]{Fig.\@ \ref{\detokenize{architecture:linkage-architecture-spa}}} provide architecture diagrams for the various integration targets.

\begin{sphinxadmonition}{warning}{Warning:}
These diagrams are informative only and do not constitute requirements. They rather aim at illustrating the data workflow and describing the main modules to develop, and how they interface with LBL or third\sphinxhyphen{}party developments.
\end{sphinxadmonition}

\begin{sphinxadmonition}{note}{Revision Note (11/2020)}

The diagrams for the desktop app and the third\sphinxhyphen{}party application are removed.
\end{sphinxadmonition}

The following definitions and conventions are used.
\begin{quote}

Config(uration) data: pieces of data provided as input to the configuration widget, see \hyperref[\detokenize{requirements:sec-data-model}]{Section \ref{\detokenize{requirements:sec-data-model}}} for definitions and \hyperref[\detokenize{annex:sec-annex-json}]{Section \ref{\detokenize{annex:sec-annex-json}}} for an actual example.

Model data: pieces of data used by the graphical editor to allow manipulating a Modelica model. Those correspond to the Modelica code as interpreted by the editor according to its specific data model.

Return \sphinxstyleemphasis{\textless{}arg\textgreater{}}: describes the translating task from one language (e.g. Modelica or Brick) or one data model (e.g. Modelica raw code or JSON) to another, specified by \sphinxstyleemphasis{\textless{}arg\textgreater{}}.

Input: describes the user action of setting a parameter value through mouse or keyboard input.

Call \textgreater{}\textgreater{} return \sphinxstyleemphasis{\textless{}arg\textgreater{}}: describes a bidirectional task where a component A calls another component B, and B returns \sphinxstyleemphasis{\textless{}arg\textgreater{}} to A.
\end{quote}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_architecture_legend}.pdf}
\caption{Software architecture legend}\label{\detokenize{architecture:linkage-architecture-legend}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_architecture_plugin}.pdf}
\caption{Software architecture for the configuration widget integrated into an existing graphical editor for Modelica}\label{\detokenize{architecture:linkage-architecture-plugin}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{linkage_architecture_spa}.pdf}
\caption{Software architecture for the full\sphinxhyphen{}featured graphical editor embedding the configuration widget \sphinxhyphen{} Standalone web app}\label{\detokenize{architecture:linkage-architecture-spa}}\end{figure}


\chapter{Annex}
\label{\detokenize{annex:annex}}\label{\detokenize{annex:sec-annex}}\label{\detokenize{annex::doc}}

\section{Example of the Configuration Data Structure}
\label{\detokenize{annex:example-of-the-configuration-data-structure}}\label{\detokenize{annex:sec-annex-json}}\sphinxSetupCaptionForVerbatim{Partial example of the configuration data structure for an air handling unit (pseudo\sphinxhyphen{}code, especially for autoreferencing the data structure and writing conditional statements)}
\def\sphinxLiteralBlockLabel{\label{\detokenize{annex:code-conf-ahu}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{p}{\PYGZob{}}
    \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}System type\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}AHU\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}subtype\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}subtype\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Type of AHU\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}VAV\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}DOA\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Supply only\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Exhaust only\PYGZdq{}}\PYG{p}{]}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}VAV\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}name\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}name\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Model name\PYGZdq{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Text input\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}AHU\PYGZdq{}}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}fluid\PYGZus{}paths\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}direction\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}east\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}medium\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Buildings.Media.Air\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}direction\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}west\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}medium\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Buildings.Media.Air\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}icon\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}path of icon.mo\PYGZdq{}}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}diagram\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nt}{\PYGZdq{}configuration\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{24}\PYG{p}{,} \PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{,}
        \PYG{n+nt}{\PYGZdq{}modelica\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{\PYGZhy{}120}\PYG{p}{,}\PYG{l+m+mi}{\PYGZhy{}200}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{120}\PYG{p}{,}\PYG{l+m+mi}{120}\PYG{p}{]}\PYG{p}{]}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}equipment\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}heaRec\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Heat recovery\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value == \PYGZsq{}DOA\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown menu\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Fixed plate\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Enthalpy wheel\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Sensible wheel\PYGZdq{}}\PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{k+kc}{null}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.HeatExchangers.PlateHeatExchangerEffectivenessNTU\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.HeatExchangers.EnthalpyWheel\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.HeatExchangers.EnthalpyWheel (sensible=true)\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}icon\PYGZus{}transformation\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}flipHorizontal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}tags\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                    \PYG{n+nt}{\PYGZdq{}port\PYGZus{}a1\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZus{}inlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}a2\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZus{}inlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}b1\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZus{}outlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}b2\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZus{}outlet\PYGZdq{}}
                \PYG{p}{\PYGZcb{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}eco\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Economizer\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value == \PYGZsq{}VAV\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown menu\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Dedicated OA damper\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Common OA damper\PYGZdq{}}\PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{k+kc}{null}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Actuators.Dampers.MixingBoxMinimumFlow\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Actuators.Dampers.MixingBox\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}icon\PYGZus{}transformation\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}flipVertical\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{9}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}tags\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                    \PYG{n+nt}{\PYGZdq{}port\PYGZus{}Out\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZus{}out\PYGZus{}inlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}OutMin\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZus{}min\PYGZus{}inlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}Sup\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZus{}outlet\PYGZdq{}}\PYG{p}{,}
                    \PYG{n+nt}{\PYGZdq{}port\PYGZus{}Exh\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZus{}outlet\PYGZdq{}}\PYG{p}{,} \PYG{n+nt}{\PYGZdq{}port\PYGZus{}Ret\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZus{}inlet\PYGZdq{}}
                \PYG{p}{\PYGZcb{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}V\PYGZus{}flowOut\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal outdoor air volume flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}eco.value != \PYGZsq{}None\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}unit\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m3/s\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.VolumeFlowRate\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}fanSup\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Supply fan\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value != \PYGZsq{}Exhaust only\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown menu\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Draw through\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Blow through\PYGZdq{}}\PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Draw through\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Movers.SpeedControlled\PYGZus{}y (m\PYGZus{}flow\PYGZus{}nominal=m\PYGZus{}flowSup\PYGZus{}nominal)\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{k+kc}{null}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{18}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}V\PYGZus{}flowSup\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal supply air volume flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}fanSup.value != \PYGZsq{}None\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}unit\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m3/s\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.VolumeFlowRate\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}fanRet\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Return/Relief fan\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value != \PYGZsq{}Supply only\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown menu\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}None\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Return\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}Relief\PYGZdq{}}\PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Relief\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{k+kc}{null}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Movers.SpeedControlled\PYGZus{}y (m\PYGZus{}flow\PYGZus{}nominal=m\PYGZus{}flowRet\PYGZus{}nominal)\PYGZdq{}}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Movers.SpeedControlled\PYGZus{}y (m\PYGZus{}flow\PYGZus{}nominal=m\PYGZus{}flowRel\PYGZus{}nominal)\PYGZdq{}}
            \PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}icon\PYGZus{}transformation\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}flipHorizontal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{k+kc}{null}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}return\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}V\PYGZus{}flowRet\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal return air volume flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}fanRet.value != \PYGZsq{}None\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}unit\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m3/s\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.VolumeFlowRate\PYGZdq{}}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}controls\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}conAHURef\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Reference guideline for control sequences\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Dropdown menu\PYGZdq{}}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}ASHRAE 2006\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}ASHRAE G36\PYGZdq{}}\PYG{p}{]}\PYG{p}{,}
                \PYG{n+nt}{\PYGZdq{}options.enabled\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                    \PYG{l+s+s2}{\PYGZdq{}Set of conditional statements allowing the use of ASHRAE 2006\PYGZdq{}}\PYG{p}{,}
                    \PYG{l+s+s2}{\PYGZdq{}Set of conditional statements allowing the use of ASHRAE G36\PYGZdq{}}
                \PYG{p}{]}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{null}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}numZon\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Total number of served VAV boxes\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{null}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}AFlo[numZon]\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Floor area of each zone\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric vector input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{null}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}have\PYGZus{}occSen\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Set to true if zones have occupancy sensor\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Boolean select\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{false}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}have\PYGZus{}winSen\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Set to true if zones have window status sensor\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Boolean select\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{false}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}have\PYGZus{}perZonRehBox\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Set to true if there is any VAV\PYGZhy{}reheat boxes on perimeter zones\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Boolean select\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{false}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}have\PYGZus{}duaDucBox\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Set to true if the AHU serves dual duct boxes\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Boolean select\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{false}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}have\PYGZus{}airFloMeaSta\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Set to true if the AHU has Air Flow Measurement Station\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Boolean select\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{false}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
                \PYG{k+kc}{null}\PYG{p}{,}
                \PYG{l+s+s2}{\PYGZdq{}Buildings.Fluid.Sensors.VolumeFlowRate (redeclare package Medium=\PYGZsh{}air\PYGZus{}supply.medium)\PYGZdq{}}\PYG{p}{,}

            \PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}if \PYGZsh{}eco.value == \PYGZsq{}Dedicated OA damper\PYGZsq{} then [20, 5] else [18, 5]\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}if \PYGZsh{}eco.value == \PYGZsq{}Dedicated OA damper\PYGZsq{} then \PYGZsq{}air\PYGZus{}supply\PYGZus{}min\PYGZsq{} else \PYGZsq{}air\PYGZus{}supply\PYGZus{}out\PYGZsq{}\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}minZonPriFlo[numZon]\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Minimum expected zone primary flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric vector input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{null}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}VPriSysMax\PYGZus{}flow[numZon]\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Maximum expected system primary airflow at design stage\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}conAHURef.value == \PYGZsq{}ASHRAE G36\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}widget\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}type\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Numeric vector input\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{null}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}\PYG{p}{,}
    \PYG{n+nt}{\PYGZdq{}dependencies\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}port\PYGZus{}outAir\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Outside air port\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value != \PYGZsq{}Exhaust only\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.Fluid.Interfaces.FluidPort\PYGZus{}a (redeclare package Medium=\PYGZsh{}air\PYGZus{}supply.medium)\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}port\PYGZus{}supAir\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Supply air port\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}subtype.value != \PYGZsq{}Exhaust only\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.Fluid.Interfaces.FluidPort\PYGZus{}b (redeclare package Medium=\PYGZsh{}air\PYGZus{}supply.medium)\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}placement\PYGZdq{}}\PYG{p}{:} \PYG{p}{[}\PYG{l+m+mi}{18}\PYG{p}{,} \PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}connect\PYGZdq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}
                \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}air\PYGZus{}supply\PYGZdq{}}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m\PYGZus{}flowOut\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal outdoor air mass flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}V\PYGZus{}flowOut\PYGZus{}nominal.enabled\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.MassFlowRate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}(\PYGZsh{}air\PYGZus{}supply.medium).rho\PYGZus{}default * V\PYGZus{}flowOut\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}protected\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{true}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m\PYGZus{}flowSup\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal supply air mass flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}V\PYGZus{}flowSup\PYGZus{}nominal.enabled\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.MassFlowRate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}(\PYGZsh{}air\PYGZus{}supply.medium).rho\PYGZus{}default * V\PYGZus{}flowSup\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}protected\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{true}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m\PYGZus{}flowRet\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal return air mass flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}V\PYGZus{}flowRet\PYGZus{}nominal.enabled\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.MassFlowRate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}(\PYGZsh{}air\PYGZus{}supply.medium).rho\PYGZus{}default * V\PYGZus{}flowRet\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}protected\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{true}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZob{}}
            \PYG{n+nt}{\PYGZdq{}\PYGZdl{}id\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m\PYGZus{}flowRel\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}description\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Nominal relief air mass flow rate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}enabled\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}\PYGZsh{}eco.value != \PYGZsq{}None\PYGZsq{}\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}declaration\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}Modelica.SIunits.MassFlowRate\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}value\PYGZdq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}m\PYGZus{}flowRet\PYGZus{}nominal \PYGZhy{} m\PYGZus{}flowSup\PYGZus{}nominal + m\PYGZus{}flowOut\PYGZus{}nominal\PYGZdq{}}\PYG{p}{,}
            \PYG{n+nt}{\PYGZdq{}protected\PYGZdq{}}\PYG{p}{:} \PYG{k+kc}{true}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{]}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\section{Main Features of the Expandable Connectors}
\label{\detokenize{annex:main-features-of-the-expandable-connectors}}\label{\detokenize{annex:sec-annex-bus-example}}
The main features of the expandable connectors (as described in \hyperref[\detokenize{requirements:sec-signal-connectors}]{Section \ref{\detokenize{requirements:sec-signal-connectors}}}) are illustrated with a minimal example described in the figures below where:
\begin{itemize}
\item {} 
a controlled system consisting in a sensor (idealized with a real expression) and an actuator (idealized with a simple block passing through the value of the input control signal) is connected with,

\item {} 
a controller system which divides the input variable (measurement) by itself and thus outputs a control variable equal to one.

\item {} 
The same model is first implemented with an expandable connector and then with a standard connector.

\end{itemize}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestExp}.pdf}
\caption{Minimal example illustrating the connection scheme with an expandable connector \textendash{} Top level}\label{\detokenize{annex:bustestexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestExp}
\PYG{n}{BusTestControllerExp} \PYG{n}{controllerSystem}\PYG{p}{;}
\PYG{n}{BusTestControlledExp} \PYG{n}{controlledSystem}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{controllerSystem}\PYG{o}{.}\PYG{n}{ahuBus}\PYG{p}{,} \PYG{n}{controlledSystem}\PYG{o}{.}\PYG{n}{ahuBus}\PYG{p}{);}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestExp}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestControlledExp}.pdf}
\caption{Minimal example illustrating the connection scheme with an expandable connector \textendash{} Controlled component sublevel}\label{\detokenize{annex:bustestcontrolledexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestControlledExp}
\PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Sources}\PYG{o}{.}\PYG{n}{RealExpression} \PYG{n}{sensor}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n+nb}{sin}\PYG{p}{(}\PYG{n+nb}{time}\PYG{o}{*}\PYG{l+m+mf}{3.14}\PYG{p}{));}
\PYG{n}{Buildings}\PYG{o}{.}\PYG{n}{Experimental}\PYG{o}{.}\PYG{n}{Templates}\PYG{o}{.}\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{AhuBus} \PYG{n}{ahuBus}\PYG{p}{;}
\PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Routing}\PYG{o}{.}\PYG{n}{RealPassThrough} \PYG{n}{actuator}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{sensor}\PYG{o}{.}\PYG{n}{y}\PYG{p}{,} \PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{yMea}\PYG{p}{);}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{yAct}\PYG{p}{,} \PYG{n}{actuator}\PYG{o}{.}\PYG{n}{u}\PYG{p}{);}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestControlledExp}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{expandable} \PYG{k+kr}{connector} \PYG{n+nc}{AhuBus}
\PYG{k+kr}{extends} \PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Icons}\PYG{o}{.}\PYG{n}{SignalBus}\PYG{p}{;}
\PYG{k+kr}{end} \PYG{n+nc}{AhuBus}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{sphinxadmonition}{note}{Note:}
The definition of \sphinxcode{\sphinxupquote{AhuBus}} in the code snippet here above does not include any variable declaration. However the variables \sphinxcode{\sphinxupquote{ahuBus.yAct}} and \sphinxcode{\sphinxupquote{ahuBus.yMea}} are used in \sphinxcode{\sphinxupquote{connect}} equations. That is only possible with an expandable connector.
\end{sphinxadmonition}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestControllerExp}.pdf}
\caption{Minimal example illustrating the connection scheme with an expandable connector \textendash{} Controller component sublevel}\label{\detokenize{annex:bustestcontrollerexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestControlledExp}
      \PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Sources}\PYG{o}{.}\PYG{n}{RealExpression} \PYG{n}{sensor}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n+nb}{sin}\PYG{p}{(}\PYG{n+nb}{time}\PYG{o}{*}\PYG{l+m+mf}{3.14}\PYG{p}{));}
      \PYG{n}{Buildings}\PYG{o}{.}\PYG{n}{Experimental}\PYG{o}{.}\PYG{n}{Templates}\PYG{o}{.}\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{AhuBus} \PYG{n}{ahuBus}\PYG{p}{;}
      \PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Routing}\PYG{o}{.}\PYG{n}{RealPassThrough} \PYG{n}{actuator}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{yAct}\PYG{p}{,} \PYG{n}{actuator}\PYG{o}{.}\PYG{n}{u}\PYG{p}{);}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{sensor}\PYG{o}{.}\PYG{n}{y}\PYG{p}{,} \PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{yMea}\PYG{p}{)}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestControlledExp}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestNonExp}.pdf}
\caption{Minimal example illustrating the connection scheme with a standard connector \textendash{} Top level}\label{\detokenize{annex:bustestnonexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestNonExp}
\PYG{n}{BusTestControllerNonExp} \PYG{n}{controllerSystem}\PYG{p}{;}
\PYG{n}{BusTestControlledNonExp} \PYG{n}{controlledSystem}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{controllerSystem}\PYG{o}{.}\PYG{n}{nonExpandableBus}\PYG{p}{,} \PYG{n}{controlledSystem}\PYG{o}{.}\PYG{n}{nonExpandableBus}\PYG{p}{);}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestNonExp}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestControlledNonExp}.pdf}
\caption{Minimal example illustrating the connection scheme with a standard connector \textendash{} Controlled component sublevel}\label{\detokenize{annex:bustestcontrollednonexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestControlledNonExp}
\PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Sources}\PYG{o}{.}\PYG{n}{RealExpression} \PYG{n}{sensor}\PYG{p}{(}\PYG{n}{y}\PYG{o}{=}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n+nb}{sin}\PYG{p}{(}\PYG{n+nb}{time}\PYG{o}{*}\PYG{l+m+mf}{3.14}\PYG{p}{));}
\PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Routing}\PYG{o}{.}\PYG{n}{RealPassThrough} \PYG{n}{actuator}\PYG{p}{;}
\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{NonExpandableBus} \PYG{n}{nonExpandableBus}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{n}{nonExpandableBus}\PYG{o}{.}\PYG{n}{yMea} \PYG{o}{=} \PYG{n}{sensor}\PYG{o}{.}\PYG{n}{y}\PYG{p}{;}
      \PYG{n}{actuator}\PYG{o}{.}\PYG{n}{u} \PYG{o}{=} \PYG{n}{nonExpandableBus}\PYG{o}{.}\PYG{n}{yAct}\PYG{p}{;}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestControlledNonExp}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{connector} \PYG{n+nc}{NonExpandableBus}
\PYG{c+c1}{// The following declarations are required.}
\PYG{c+c1}{// The variables are not considered as connectors: they cannot be part of connect equations.}
\PYG{n+nb}{Real} \PYG{n}{yMea}\PYG{p}{;}
\PYG{n+nb}{Real} \PYG{n}{yAct}\PYG{p}{;}
\PYG{k+kr}{end} \PYG{n+nc}{NonExpandableBus}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{BusTestControllerNonExp}.pdf}
\caption{Minimal example illustrating the connection scheme with a standard connector \textendash{} Controller component sublevel}\label{\detokenize{annex:bustestcontrollernonexp}}\end{figure}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{model} \PYG{n+nc}{BusTestControllerNonExp}
\PYG{n}{Controls}\PYG{o}{.}\PYG{n}{OBC}\PYG{o}{.}\PYG{n}{CDL}\PYG{o}{.}\PYG{n}{Continuous}\PYG{o}{.}\PYG{n}{Division} \PYG{n}{controller}\PYG{p}{;}
\PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Blocks}\PYG{o}{.}\PYG{n}{Routing}\PYG{o}{.}\PYG{n}{RealPassThrough} \PYG{n}{realPassThrough}\PYG{p}{;}
\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{NonExpandableBus} \PYG{n}{nonExpandableBus}\PYG{p}{;}
\PYG{k+kr}{equation}
      \PYG{k+kr}{connect}\PYG{p}{(}\PYG{n}{realPassThrough}\PYG{o}{.}\PYG{n}{y}\PYG{p}{,} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{u1}\PYG{p}{);}
      \PYG{n}{controller}\PYG{o}{.}\PYG{n}{u2} \PYG{o}{=} \PYG{n}{nonExpandableBus}\PYG{o}{.}\PYG{n}{yMea}\PYG{p}{;}
      \PYG{n}{nonExpandableBus}\PYG{o}{.}\PYG{n}{yAct} \PYG{o}{=} \PYG{n}{controller}\PYG{o}{.}\PYG{n}{y}\PYG{p}{;}
      \PYG{n}{realPassThrough}\PYG{o}{.}\PYG{n}{u} \PYG{o}{=} \PYG{n}{nonExpandableBus}\PYG{o}{.}\PYG{n}{yMea}\PYG{p}{;}
\PYG{k+kr}{end} \PYG{n+nc}{BusTestControllerNonExp}\PYG{p}{;}
\end{sphinxVerbatim}


\section{Validating the Use of Expandable Connectors}
\label{\detokenize{annex:validating-the-use-of-expandable-connectors}}\label{\detokenize{annex:sec-annex-bus-valid}}
The use of expandable connectors (control bus) is validated in case of a complex controller (\sphinxcode{\sphinxupquote{Buildings.Controls.OBC.ASHRAE.G36\_PR1.AHUs.MultiZone.VAV.Controller}}).

The validation is performed
\begin{itemize}
\item {} 
with Dymola (Version 2020, 64\sphinxhyphen{}bit, 2019\sphinxhyphen{}04\sphinxhyphen{}10) and JModelica (revision numbers from svn: JModelica 12903, Assimulo 873);

\item {} 
first with a single instance of the controller and then with multiple instances corresponding to different parameters set up (see validation cases of the original controller \sphinxcode{\sphinxupquote{Validation.Controller}} and \sphinxcode{\sphinxupquote{Validation.ControllerConfigurationTest}}),

\item {} 
with nested expandable connectors: a top\sphinxhyphen{}level control bus composed of a first sub\sphinxhyphen{}level control bus for control output variables and another for control input variables.

\end{itemize}

Simulation succeeds for the two tests cases with the two simulation tools.
The results comparison to the original test case (without control bus) is presented in \hyperref[\detokenize{annex:annex-valid-bus}]{Fig.\@ \ref{\detokenize{annex:annex-valid-bus}}} for Dymola.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=800\sphinxpxdimen]{{annex_valid_bus}.pdf}
\caption{G36 AHU controller model: comparison of simulation results (Dymola) between implementation without (\sphinxcode{\sphinxupquote{origin}}) and with (\sphinxcode{\sphinxupquote{new\_bus}}) expandable connectors}\label{\detokenize{annex:annex-valid-bus}}\end{figure}


\section{Validating the Use of Expandable Connector Arrays}
\label{\detokenize{annex:validating-the-use-of-expandable-connector-arrays}}\label{\detokenize{annex:sec-annex-bus-array}}
Minimum examples illustrate that arrays of expandable connectors are differentially supported between Dymola and OCT. None of the tested Modelica tools seems to have a fully robust support. However, by reporting those bugs, it seems as a feature we can leverage for Linkage.

We start with the basic definition of an expandable connector \sphinxcode{\sphinxupquote{AhuBus}} containing the declaration of an array of expandable connectors \sphinxcode{\sphinxupquote{ahuTer}} that will be used to connect the signal variables from the terminal unit model. In addition we build dummy models for a central system (e.g. VAV AHU) and a terminal system (e.g. VAV box) as illustrated in the figures hereafter. The input signal \sphinxcode{\sphinxupquote{inpSig}} is typically generated by a sensor from the terminal system and must be passed on to the central system which, in response, outputs the signal \sphinxcode{\sphinxupquote{outsig}} typically used to control an actuator position in the terminal unit.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kr}{expandable} \PYG{k+kr}{connector} \PYG{n+nc}{AhuBus}
   \PYG{k+kr}{extends} \PYG{n}{Modelica}\PYG{o}{.}\PYG{n}{Icons}\PYG{o}{.}\PYG{n}{SignalBus}\PYG{p}{;}
   \PYG{k+kr}{parameter} \PYG{n+nb}{Integer} \PYG{n}{nTer}\PYG{o}{=}\PYG{l+m+mi}{0}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Number of terminal units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
      \PYG{c+c1}{// annotation(Dialog(connectorSizing=true)) is not interpreted properly in Dymola.}
   \PYG{n}{Buildings}\PYG{o}{.}\PYG{n}{Experimental}\PYG{o}{.}\PYG{n}{Templates}\PYG{o}{.}\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{TerminalBus} \PYG{n}{ahuTer}\PYG{p}{[}\PYG{n}{nTer}\PYG{p}{]} \PYG{k+kr}{if}  \PYG{n}{nTer} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Terminal unit sub\PYGZhy{}bus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
\PYG{k+kr}{end} \PYG{n+nc}{AhuBus}\PYG{p}{;}
\end{sphinxVerbatim}

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{DummyCentral}.png}
\end{figure}

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{DummyTerminal}.png}
\end{figure}


\subsection{Connecting One Central System Model to an Array of Terminal System Models}
\label{\detokenize{annex:connecting-one-central-system-model-to-an-array-of-terminal-system-models}}
The first test is illustrated in the figure below.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{ControlBusArrayManual}.png}
\end{figure}

\sphinxtitleref{Bug in Dymola}

Dymola GUI does not allow graphically generating the statement \sphinxcode{\sphinxupquote{connect(dummyTerminal.terBus, dummyCentral.ahuBus.ahuTer)}}. The GUI returns the error message \sphinxcode{\sphinxupquote{Incompatible connectors}}.

However, we cannot find which part of the specification \sphinxcite{bibliography:modelica2017} this statement would violate. To the contrary, the specification states that “expandable connectors can be connected even if they do not contain the same components”.

Additionally, when manually adding this \sphinxcode{\sphinxupquote{connect}} statement in the code, the model simulates (with correct results) with OCT. Dymola fails to translate the model and returns the error message \sphinxcode{\sphinxupquote{Connect argument was not one of the valid forms, since dummyCentral is not a connector}}.

Based on various tests we performed, it seems that Dymola supports connecting \sphinxstyleemphasis{inside} expandable connectors together only when they are instances of the same class. Again, we cannot find such a requirement in Modelica specification. To allow such a connection in Dymola, we need to rely on an \sphinxstyleemphasis{outside} expandable connector as illustrated below.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{ControlBusArray}.png}
\end{figure}

\sphinxtitleref{Bug in OCT}

With this connection layout, the model simulates with Dymola but no more with OCT which returns the following error message.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{Error} \PYG{n}{at} \PYG{n}{line} \PYG{l+m+mi}{296}\PYG{p}{,} \PYG{n}{column} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{o+ow}{in} \PYG{n}{file} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{/opt/oct/ThirdParty/MSL/Modelica/Blocks/Interfaces.mo}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
\PYG{n}{Cannot} \PYG{n}{find} \PYG{k}{class} \PYG{n+nc}{declaration} \PYG{k}{for} \PYG{n}{RealInput}
\end{sphinxVerbatim}

\sphinxtitleref{Bug in Dymola}

Incidentally we observe other bugs in Dymola related to the elaboration process leading to a variable being marked as present in the expandable connector variable set.
\begin{itemize}
\item {} 
When connecting a non declared variable to a sub\sphinxhyphen{}bus, e.g., \sphinxcode{\sphinxupquote{connect(ahuBus.ahuTer.inpSig, inpSig.u)}}, the corresponding expandable connector variable list (visible in Dymola GUI under \sphinxcode{\sphinxupquote{\textless{}Add Variable\textgreater{}}} when drawing a connection to the connector) does not get augmented with the variable name.

\item {} 
When connecting a non declared variable directly to an array of expandable connectors as in the figure below, the dimensionality may be wrong depending on the first connection being established. Indeed, \sphinxcode{\sphinxupquote{terBus.inpSig}} is considered as an array if \sphinxcode{\sphinxupquote{terBus{[}:{]}.inpSig}} is first connected to a one\sphinxhyphen{}dimensional array of scalar variables. The code needs to be updated manually to suppress the array index and simulate. If the first connection of \sphinxcode{\sphinxupquote{inpSig}} variable to the connector is made at the terminal unit level (scalar to scalar) then the dimensionality is correctly established.

\item {} 
In several use cases, we noticed similar issues related to the dimensionality of variables in presence of nested expandable connectors. In that respect OCT appears more robust.

\end{itemize}

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{DummyCentralBug}.png}
\end{figure}


\subsection{Connecting an Array of Central System Models to an Array of Terminal System Models}
\label{\detokenize{annex:connecting-an-array-of-central-system-models-to-an-array-of-terminal-system-models}}
We now try to connect an one\sphinxhyphen{}dimensional array of central system models \sphinxcode{\sphinxupquote{DummyCentral dummyCentral{[}nAhu{]}}} to a two\sphinxhyphen{}dimensional array of terminal system models \sphinxcode{\sphinxupquote{DummyTerminal dummyTerminal{[}nAhu, nTerAhu{]}}}.

\sphinxtitleref{Bug in Dymola}

As explained before, in Dymola, we need to rely to an \sphinxstyleemphasis{outside} expandable connector to connect the two \sphinxstyleemphasis{inside} expandable connectors.

\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{ControlBusArrayArray}.png}
\end{figure}

However, despite the connection being made properly through the GUI, the model fails to translate.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{Unmatched} \PYG{n}{dimension} \PYG{o+ow}{in} \PYG{n}{connect}\PYG{p}{(}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuTer}\PYG{p}{,} \PYG{n}{dummyTerminal}\PYG{o}{.}\PYG{n}{terBus}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{The} \PYG{n}{first} \PYG{n}{argument}\PYG{p}{,} \PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuTer}\PYG{p}{,} \PYG{o+ow}{is} \PYG{n}{a} \PYG{n}{connector} \PYG{k}{with} \PYG{l+m+mi}{1} \PYG{n}{dimensions}
\PYG{o+ow}{and} \PYG{n}{the} \PYG{n}{second}\PYG{p}{,} \PYG{n}{dummyTerminal}\PYG{o}{.}\PYG{n}{terBus}\PYG{p}{,} \PYG{o+ow}{is} \PYG{n}{a} \PYG{n}{connector} \PYG{k}{with} \PYG{l+m+mi}{2} \PYG{n}{dimensions}\PYG{o}{.}
\end{sphinxVerbatim}

The error message is incorrect as in this case \sphinxcode{\sphinxupquote{ahuBus.ahuTer}} has two dimensions.

OCT also fails to translate the model but for a different reason, see error message previously mentioned.
However, when manually adding the connect statement between the two \sphinxstyleemphasis{inside} connectors \sphinxcode{\sphinxupquote{connect(dummyTerminal.terBus, dummyCentral.ahuBus.ahuTer)}}, the model simulates with OCT.


\subsection{Passing on a Scalar Variable to an Array of System Models}
\label{\detokenize{annex:passing-on-a-scalar-variable-to-an-array-of-system-models}}
The typical use case is a schedule, set point, or central system status value that is used as a common input to a set of terminal units.
Two programmatic options are obviously available.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Instantiating a replicator (routing) component to connect the variable to the expandable connector array. After discussion with the team, it seems like the best approach to use in production.

\item {} 
Looping over the expandable connector array elements to connect each of them to the variable.

\end{enumerate}

The test performed here aims to provide a more “user\sphinxhyphen{}friendly” way of achieving the same result with only one connection being made (either graphically or programmatically).

The best approach would be a binding of the variable in the declaration of the expandable connector array.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{expandable} \PYG{n}{connector} \PYG{n}{AhuBus}
   \PYG{n}{parameter} \PYG{n}{Integer} \PYG{n}{nTer}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Number of terminal units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
   \PYG{n}{Boolean} \PYG{n}{staAhu}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Test how a scalar variable can be passed on to an array of connected units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
   \PYG{n}{Buildings}\PYG{o}{.}\PYG{n}{Experimental}\PYG{o}{.}\PYG{n}{Templates}\PYG{o}{.}\PYG{n}{BaseClasses}\PYG{o}{.}\PYG{n}{TerminalBus} \PYG{n}{ahuTer}\PYG{p}{[}\PYG{n}{nTer}\PYG{p}{]}\PYG{p}{(}
      \PYG{n}{each} \PYG{n}{staAhu}\PYG{o}{=}\PYG{n}{staAhu}\PYG{p}{)} \PYG{k}{if} \PYG{n}{nTer} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Terminal unit sub\PYGZhy{}bus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
\PYG{n}{end} \PYG{n}{AhuBus}\PYG{p}{;}
\end{sphinxVerbatim}

However that syntax is against the Modelica language specification.
It is indeed equivalent to an equation, and equations are not allowed in an expandable connector class.

The approach eventually tested relies on a so\sphinxhyphen{}called “gateway” model composed of several instances of expandable connectors and an equation section used to establish the needed connect statements. Note that if a variable is left unconnected then it is considered undefined, so the corresponding connect statement is automatically removed by Modelica tools.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{model} \PYG{n}{AhuBusGateway}
   \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Model to connect scalar variables from main bus to an array of sub\PYGZhy{}bus}\PYG{l+s+s2}{\PYGZdq{}}
   \PYG{n}{parameter} \PYG{n}{Integer} \PYG{n}{nTer}
      \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Number of terminal units}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{;}
   \PYG{n}{AhuBus} \PYG{n}{ahuBus}\PYG{p}{(}\PYG{n}{nTer}\PYG{o}{=}\PYG{n}{nTer}\PYG{p}{)}\PYG{p}{;}
   \PYG{n}{TerminalBus} \PYG{n}{terBus}\PYG{p}{[}\PYG{n}{nTer}\PYG{p}{]}\PYG{p}{;}
\PYG{n}{equation}
   \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{l+m+mi}{1}\PYG{p}{:}\PYG{n}{nTer} \PYG{n}{loop}
      \PYG{n}{connect}\PYG{p}{(}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{staAhu}\PYG{p}{,} \PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuTer}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{staAhu}\PYG{p}{)}\PYG{p}{;}
   \PYG{n}{end} \PYG{k}{for}\PYG{p}{;}
   \PYG{n}{connect}\PYG{p}{(}\PYG{n}{ahuBus}\PYG{o}{.}\PYG{n}{ahuTer}\PYG{p}{,} \PYG{n}{terBus}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{end} \PYG{n}{AhuBusGateway}\PYG{p}{;}
\end{sphinxVerbatim}

\sphinxtitleref{Bug in Dymola}

When trying to simulate a model using such a component Dymola fails to translate and returns:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{The} \PYG{n}{bus}\PYG{o}{\PYGZhy{}}\PYG{n+nb}{input} \PYG{n}{dummyTerminal}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{terBus}\PYG{o}{.}\PYG{n}{staAhu} \PYG{n}{lacks} \PYG{n}{a} \PYG{n}{matching} \PYG{n}{non}\PYG{o}{\PYGZhy{}}\PYG{n+nb}{input} \PYG{o+ow}{in} \PYG{n}{the} \PYG{n}{connection} \PYG{n}{sets}\PYG{o}{.}
\PYG{n}{This} \PYG{n}{means} \PYG{n}{that} \PYG{n}{it} \PYG{n}{lacks} \PYG{n}{a} \PYG{n}{source} \PYG{n}{writing} \PYG{n}{the} \PYG{n}{signal} \PYG{n}{to} \PYG{n}{the} \PYG{n}{bus}\PYG{o}{.}
\end{sphinxVerbatim}

However, OCT simulates the model properly.


\chapter{Acknowledgments}
\label{\detokenize{acknowledgments:acknowledgments}}\label{\detokenize{acknowledgments::doc}}
This research was supported by the Assistant Secretary for Energy
Efficiency and Renewable Energy, Office of Building Technologies of
the U.S. Department of Energy, under Contract No. DE\sphinxhyphen{}AC02\sphinxhyphen{}05CH11231.


\chapter{References}
\label{\detokenize{bibliography:references}}\label{\detokenize{bibliography:id1}}\label{\detokenize{bibliography::doc}}




\begin{sphinxthebibliography}{LBNL19}
\bibitem[Mod17]{bibliography:modelica2017}
\sphinxstyleemphasis{Modelica \textendash{} A Unified Object\sphinxhyphen{}Oriented Language for Physical Systems Modeling, Language Specification, Version 3.4}. Modelica Association, April 2017. URL: \sphinxurl{https://www.modelica.org/documents/ModelicaSpec34.pdf}.
\bibitem[LBNL19]{bibliography:obc}
\sphinxstyleemphasis{OpenBuildingControl Specification}. LBNL, 2019. URL: \sphinxurl{https://obc.lbl.gov/specification/index.html}.
\end{sphinxthebibliography}



\renewcommand{\indexname}{Index}
\printindex
\end{document}